<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Profile</title>
    <link rel="icon" type="image/png" href="../static/image/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" media="screen" href="../static/css/mainprofile.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/js/jQuery-tagEditor-master/jquery.tag-editor.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="../static/js/jquery-ui-1.12.1.custom/jquery-ui.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="/static/js/jquery-3.3.1.min.js"></script>
    <script src="//code.jquery.com/jquery-1.9.1.js"></script>
    <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>

    <script src="../static/js/mainprofile.js"></script>

    <meta name="google-signin-scope" content="">
    <meta name="google-signin-client_id" content="976545483152-3u1fctn90tf0qvjevud1hkfu3jdneog0.apps.googleusercontent.com">
    <meta name="google-signin-client_secret" content="dhayVHWZ-OsnjdQO47qZXhOD">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <link href="../static/css/sideChat.css" rel="stylesheet">
    <script src="https://cdn.ckeditor.com/4.9.2/standard/ckeditor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.0/socket.io.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <script src="../static/js/jQuery-tagEditor-master/jquery.tag-editor.min.js"></script>
    <script src="../static/js/jQuery-tagEditor-master/jquery.caret.min.js"></script>
</head>

<body>
    <div class="profile-fullpage">
        
        
                <div class="profile-nav">
                    <div class="profile-search">
                        <form action="/search" method="POST">
                        <button id="autocom" class="profile-searchbutton" type="submit">
                            <span class="glyphicon glyphicon-search"></span>
                        </button>
                        <input id="autocomplete" name="searchbar" class="profile-searchbar" type="text" placeholder="Search..">
                        </form>

                    </div>
                    <div class="profile-pages">

                        <a href="{{ url_for('.question') }}"><span class="glyphicon glyphicon-home"></span>  Home</a>
                        <a href=""><span class="glyphicon glyphicon-user"></span>  Profile</a>
                        <div class="dropdown" style="width: 20%; display: inline-block;"><a class="Notificationbutton  dropdown-toggle" data-toggle="dropdown" href="#" id="btn_notification"><span class="glyphicon glyphicon-bell"></span> Notifications</a><ul  style=" text-overflow:ellipsis;min-height: 200px; max-height: 500px;min-width:500px; overflow-y: auto;overflow-x: hidden" id="notification-content" class="dropdown-menu pull-right">
                        
                            </ul></div>
                        <a id="signout" style="cursor:pointer;"><span class="glyphicon glyphicon-asterisk"></span>Logout</a>

                    </div>
                </div>
                <div class="profile-contentTop">
                    <div class="profile-contentTopCover">
                        <img src="../static/image/background1.jpg" alt="profilecover">
                        <div class="profilepictureContainer">
                            <img id="profPic" src="{{ json_object.picture }}" alt="Profilepic">
                        </div>
                    </div>
                    <div class="profile-contentTopLinks">
                        <div class="profile-contentTopNav">
                            {% block body %}
                            <a style="color: white; cursor: pointer" type="submit"  id="profile-PostButton">{{questions}} Posts</a>
                            <a  style="color: white; cursor: pointer" type="submit" id="profile-FollowersButton">{{followers}} Followers</a>
                            <a  style="color: white; cursor: pointer" type="submit" id="profile-FollowingButton">{{following}} Following</a>
                            <a  style="color: white; cursor: pointer" type="submit" id="profile-FollowedQuestionButton">{{questionsfollowed}} Followed Questions</a>
                            <!-- <a type="submit" id="profile-AnsweredQuestionButton">{{answers}} Answered Questions</a>  -->
                            {% endblock %}
                            <a class="editprofilebutton" style="cursor:pointer;  color: #801515;">Edit Profile</a>
                        </div>
                        <div class="CenterLeftRightCont">
                            <div class="profile-contentLeft">

                                <!-- <h4>Bio info here</h4> -->
                                <p style="font-weight: 1000; font-size: 22px" id="dispn"> {{ json_object['displayname'] }} </p>
                                <a class="profilePostEmail"> {{json_object.email}} </a>

                                <div class="profile-linksInterest" id="interestscontainer">
                                    <div style="background-color: white; padding: 10px;">
                                    <h4> Interests</h4>
                                    <hr>
                                    <br> {% for interest in json_object1.interests %}
                                    <a style="border:1px solid black" id="int"> {{interest.name}} </a>
                                    {% endfor %}
                                </div>
                                </div>
                            </div>


                            <div class="profileCenterDiv">
                                <div class="FollowedQuestionsContainer" style="display: none;">
                                    {% for i in followed_questions|reverse %}
                                    <div class="profile-contentCenter">
                                           <div class="profilePostPictureCont">
                                                <img class="profilePostPicture" src="{{ i.user.picture }}">
        
                                            </div>
                                            <div class="profileNameEmail">
                                                <h4 class="profilePostUsername">{{i.user.displayname}}
                                                    <a style="cursor:pointer;" title ="Mark as duplicate" class="glyphicon glyphicon-duplicate pencileditbutton" id="{{i.id}}"></a></h4>
                                                <a class="profilePostEmail">{{i.user.email}}</a>
                                                <h3 class="profilePostTitle">Title:{{i.question | safe}} <a class="showallButton" type="button" style="cursor:pointer;" title="Show all"  id="{{i.id}}">Show description</a> </h3>
                                            </div>
        
                                            <br>
        
                                            <div class="profilePostAnswer" id={{"show_{0}".format(i.id)}} >{{i.questiondesc | safe}}</div>
                                            
                                            <div class="profilePostButton">     
                                                    <hr>               
                                                <a id="{{i.id}}" class="profilePostAnswerButton">View Answer</a>                                        
                                                <button  onclick = "followedQuestion('{{i.id}}')" >
                                                    
                                                </button>
                                            </div>
                                            <div class="ProfilepostAnswerDiv" id={{"ProfilepostAnswerDiv_{0}".format(i.id)}}>HEyHEYHEYHEYHEYHEYHEY</div>
                                            {% for a in i.answers %}
                                            <div class="ProfilepostAnswerDiv" id={{"ProfilepostAnswerDiv_{0}".format(i.id)}}>HEyHEYHEYHEYHEYHEYHEY</div>
                                            <div class="ProfilepostAnswerDiv" id={{"ProfilepostAnswerDiv_{0}".format(i.id)}}>
                                                    <div class="picture2" id="">
                                                            <a href="">
                                                            <img style="cursor: pointer;width: 100%; height: 100%;" src="{{a.user.picture}}">
                                                            </a>
                                                        </div>
                                                <div  id={{"ProfilepostAnswerBox_{0}".format(a.id)}} class="ProfilepostAnswerBox">
                                                    <h4>{{a.user.displayname}}</h4>
                                                    <h6>{{a.createdAt}}</h6>
                                                    <button id="{{a.id}}" onclick="answerUpvote('{{a.id}}')" class="workround1 fa fa-thumbs-up up thumbs-up" style="margin: 5px;"> {{a.upvotes}}</button>
                                                    <button id="" onclick="answerDownvote('{{a.id}}')" class="workround2 fa fa-thumbs-down down thumbs-down" style="margin: 5px;"> {{a.downvotes}}</button>
                                                    <p>{{a.answer | safe}}</p>
        
                                                </div>
                                                {% for c in a.comments %}
                                                <div  id={{"ProfilepostCommentBox_{0}".format(c.id)}} class="ProfilepostCommentBox">
                                                        <p>{{c.comment}}</p>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endfor %}
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="AnsweredQuestionsContainer">
                                       {% for question in answered_questions|reverse %}
                                    <div class="profile-contentCenter">
                                        <div class="profilePostPictureCont">
                                            <img class="profilePostPicture" src="{{ question.user.picture }}">
                                        </div>
                                        <div class="profileNameEmail">
                                            <h4 class="profilePostUsername">{{question.user.displayname}} <a href="#" class="glyphicon glyphicon-pencil"></a></h4>
                                            <a class="profilePostEmail">{{question.user.email}}</a>
                                            <h3 class="profilePostTitle">Title:{{ question.question | safe}}<a class="showallButton" type="button" title="Show all" style="cursor:pointer;" id="{{question.id}}">Show description</a></h3>
                                        </div>
                                        <div class="profilePostAnswer" id={{"show_{0}".format(question.id)}}>{{ question.questiondesc | safe }}</div>
                                        <div>{{ question.answer }}</div>
                                        <div class="profilePostButton">
                                                <a href="#"  id={{"followques_{0}".format(question.id)}} class="profilePostFollowButton">Unfollow</a>
                                           
                                            <a onclick="upvote('{{question.id}}')" class="glyphicon glyphicon-thumbs-up">  {{ question.upvotesCount}}</a>
                                            <a onclick="downvote('{{question.id}}')" class="glyphicon glyphicon-thumbs-down">  {{ question.downvotesCount}}</a>
                                            <button  onclick = "followedQuestion('{{question.id}}')" >
                                                   
                                            </button>                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="postscontainer" style="  background-color: #580D16;">
                                {% for i in posts|reverse %}

                                <div class="profile-contentCenter">
                                    <div class="profilePostPictureCont">
                                        <img class="profilePostPicture" src="{{ i.user.picture }}">

                                    </div>
                                    <div class="profileNameEmail">
                                        <h4 class="profilePostUsername">{{i.user.displayname}}
                                            <a style="cursor:pointer;" title ="Edit" class="glyphicon glyphicon-pencil pencileditbutton" onclick="showhide('{{i.id}}')" id="{{i.id}}"></a>
                                            <a style="cursor:pointer;" title ="Delete" class="glyphicon glyphicon-trash pencileditbutton" onclick="confirmDelete('{{i.id}}')" id="{{i.id}}"></a>
                                            <a style="cursor:pointer;" title ="Mark as duplicate" class="glyphicon glyphicon-duplicate pencileditbutton" id="{{i.id}}"></a></h4>
                                        <a class="profilePostEmail">{{i.user.email}}</a>
                                        <h3 class="profilePostTitle">Title:{{i.question | safe}} <a class="showallButton" type="button" style="cursor:pointer;" title="Show all"  id="{{i.id}}">Show description</a> </h3>
                                    </div>

                                    <br>

                                    <div class="profilePostAnswer" id={{"show_{0}".format(i.id)}} >{{i.questiondesc | safe}}</div>
                                    
                                    <div class="profilePostButton">     
                                            <hr>               
                                        <a id="{{i.id}}" class="profilePostAnswerButton">View Answer</a>                                        
                                        <button  onclick = "followedQuestion('{{i.id}}')" >
                                            
                                        </button>
                                    </div>
                                    {% for a in i.answers %}
                                    <div class="ProfilepostAnswerDiv" id={{"ProfilepostAnswerDiv_{0}".format(i.id)}}>
                                            <div class="picture2" id="">
                                                    <a href="">
                                                    <img style="cursor: pointer;width: 100%; height: 100%;" src="{{a.user.picture}}">
                                                    </a>
                                                </div>
                                        <div  id={{"ProfilepostAnswerBox_{0}".format(a.id)}} class="ProfilepostAnswerBox">
                                            <h4>{{a.user.displayname}}</h4>
                                            <h6>{{a.createdAt}}</h6>
                                            <button id="{{a.id}}" onclick="answerUpvote('{{a.id}}')" class="workround1 fa fa-thumbs-up up thumbs-up" style="margin: 5px;"> {{a.upvotes}}</button>
                                            <button id="" onclick="answerDownvote('{{a.id}}')" class="workround2 fa fa-thumbs-down down thumbs-down" style="margin: 5px;"> {{a.downvotes}}</button>
                                            <p>{{a.answer | safe}}</p>

                                        </div>
                                        {% for c in a.comments%}
                                        <div  id={{"ProfilepostCommentBox_{0}".format(c.id)}} class="ProfilepostCommentBox">
                                                <p>{{c.comment}}</p>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endfor %}
                    <div class="form2container"  id={{"edit_{0}".format(i.id)}} style="z-index: 10003;">    

                            <form class = "form2" id={{"editform_{0}".format(i.id)}} style="margin-top: -250px;">
    
                                <h5>Title</h5>
                                <input class="editQuestionTitle" type="text" id="titleedit" value="{{i.question}}">
                                <h5>Description</h5>
                                <textarea name={{"editquestion_{0}".format(i.id)}} id={{"editquestion_{0}".format(i.id)}} style="border: 1px solid black; height:200px; font-size:14pt;" rows="9" type="text" class="editTitleDescription" id="descedit">{{i.questiondesc}}</textarea>
                                <script>
                                    CKEDITOR.replace('{{"editquestion_{0}".format(i.id)}}')
                                </script>
    
                                <h5>Tags</h5>
                                <input id="tagsIDedit" type="text" name="tagsarea" value=" {% for tag in i.tags %} {{tag.name}} {% endfor %}" class="tagsarea" />
                               
                                <div class="popupedit" id="{{i.category.id}}">
                                        <button id="categoryIDedit" type="button" value="" class="categorybuttonedit">
                                            <b>Category:</b>
                                        </button>
                                        <button class="selectedcategorybuttonedit" type="button">
                                            {{ i.category.name }}
                                        </button>
                                </div>
    
                                <div class="newsfeedPopUpButton-Cont">
                                    <!-- <button type="submit" id="{{i.id}}" style="margin-left: -10%" class="submitbutton5">Submit</button> -->
                                    <a style="cursor:pointer;" id="{{i.id}}" class="submitbutton5" type="submit">Save</a>
                                    <a style="cursor:pointer;" onclick="showhide({{ i.id }})">Cancel</a>
    
    
                                    <!--                    <a id={{i.id}} class="submitbutton5" type="submit" >Save</a>
                                     <a class="submitbutton5" onclick="showhide({{i.id}})" >Cancel</a> -->
                                </div>
                            </form>
                          </div>
                                </div>
                                {%endfor%}
                            </div>

                        </div>
                            <div>
                                <a href=" "> </a>
                            </div>
                            <div class="FollowersContainer">
                                {% for follower in json_object1.followers %}
                                <div class="FollowersRow">

                                    <a href="{{ url_for('.profile', id = follower.id) }}">
                                        <div class="col-md-3 col-sm-6">
                                            <div class="our-team">
                                                <div class="FollowersPic">
                                                    <img style="width: 100%; height: 100%;" src="{{ follower.picture }}">
                                                    <div class="team-content">
                                                        <h3 class="FollowersTitle">{{ follower.displayname }}</h3>
                                                       
                                                    </div>
                                                </div>
                                                <ul class="social">
                                                <button  onclick = "followedUser('{{follower.id}}')" >
                                                    <a style="color: white;" href="#"  id={{"followuser_{0}".format(follower.id)}} class="followerButton">Unfollow</a>
                                                </button>

                                                </ul>
                                            </div>
                                        </div>
                                    </a>

                                </div>
                                {% endfor %}
                            </div>



                            <div class="profile-contentRight">
                                <div style="background-color: white; padding: 10px;">
                                <h4>Who to Follow</h4>
                                <hr>
                    
                                {% for i in whotofollowusers %}
                                 <div class="whotoFollowss" id= {{"whotoFollow_{0}".format(i.id)}}>
                                    <!-- <div class="whotoFollowss" id= "{{ i.displayname }}"> -->
                                <div class="picturess">
                                    <img class="profileimagess" src="{{ i.picture }}">
                                </div>
            
                                <button  onclick = "followable('{{i.id}}')" class="whotofollowButtonss">
                                    <a href="#"  id={{"followa_{0}".format(i.id)}} >Follow</a>
                            </button>
                                <div class="whotoFollowNamess">
                                    <a href="{{ url_for('.profile', id = i.id) }}" >{{ i.displayname }}</a>

                                    <a>{{ i.email }}</a>
                                </div>
            
                            </div>
                            {% endfor %}
            
            
                             <a>
                                <h4>See all</h4>
                            </a>
                        </div>
                    </div>

                            <div class="FollowingContainer">
                                {% for g in json_object1.following %}
                                <div class="FollowersRow">

                                    <a href="{{ url_for('.profile', id = g.id) }}">
                                        <div class="col-md-3 col-sm-6">
                                            <div class="our-team">
                                                <div class="FollowersPic">
                                                    <img style="width: 100%; height: 100%;" src="{{ g.picture }}">
                                                    <div class="team-content">
                                                        <h3 class="FollowersTitle">{{ g.displayname }}</h3>
                                                       
                                                    </div>
                                                </div>
                                                <ul class="social">                                                  
                                                        <button  onclick = "followedUser('{{g.id}}')" >
                                                            <a style="color: white;" href="#"  id={{"followuser_{0}".format(g.id)}} class="followerButton">Unfollow</a>
                                                        </button>                                                  
                                                </ul>
                                            </div>
                                            <br>
                                        </div>
                                    </a>

                                </div>
                                {% endfor %}
                            </div>
                            </div>
                        </div>

                    </div>
                
           
        </div>

    </div>
    </div>

    </div>


    </div>
    </div>


    </div>

    </div>
    </div>

    </div>

    </div>

    <div id="modalProf" class="modal">
        <div class="modal_close close"></div>
        <div class="modal_main">
            <img src="/static/images/ic.png" class="close" style="height: 20px; width: 20px; margin-top:13px;left:96%;position:fixed;">
            <form class="form form-vertical" action="http://iitoverflow.herokuapp.com/api/users/{{curuser}}/updatePofile" method="post" enctype="multipart/form-data">


                <div class="kv-avatar">
                    <div class="file-loading">
                        <input id="avatar-1" name="file" type="file">
                    </div>
                </div>
                <div style="border: 1px solid #801515; padding: 10px; border-radius: 10px; width: 50%;display: inline-block; text-align: left; ">
                <label>Display name: </label><input type="text" id="dispName" value="{{ json_object['displayname'] }}" placeholder="Displayname"></div>
                    <br>
                    <br>
                    <br>
                <div id="interest-contain" style="width: 47%; float: left; overflow-y: auto; height: 40%;">
                    <h5>Interests: </h5>
                    {% for i in interests%}
                    <button value="{{i.id}}" type="button" class="interestbuttons" id="">{{ i.name }}</button>
                    {% endfor %}
                </div>
                <div id="category-contain" style="width: 47%; float: left; overflow-y: auto; height: 40%;">
                    <h5>Categories: </h5>
                    {% for c in categories%} {% if c not in interests %}
                    <button value="{{c.id}}" type="button" class="categorybuttons">{{ c.name }}</button>
                    {% endif %}{% endfor %}
                </div>
                <button type="submit" id="submitProfile" style="margin-left: -10%" class="submitEditbutton">Submit</button>

            </form>

        </div>
    </div>
    <div id="myModal" class="modal">
            <!-- Modal content -->
            <div class="modal-content" style="margin-top: 30%;">
                <span class="close">&times;</span> {% for category in categories %}
                <a id="{{category.id}}" class="categorypopups"> {{category.name}} </a> {% endfor %}
            </div>
        </div>
    <script src="../static/js/autocompleteJS.js"></script>
    <script src="../static/js/app2.js"></script>
    <!--<script src="../static/js/app2.js"></script>-->
    <div id="sideChat"></div>
</body>

<script type="text/javascript">
    $('.tagsarea').tagEditor({

    });
    ///////////////////////////////////////////////////////////////////////////////////
    $(document).on('click', '.categorybuttonedit', function () {
            $("#myModal").show();
            $("#myModal").css("z-index", "10004");
        });

    ///////////////////////////////////////////////////////////////////////////////////
    $(document).on('click', '.categorypopups', function () {
            var catty, cattyid, selectedCategory, btn, text2;
            catty = this.text;
            cattyid = $(this).attr('id');
            text2 = document.createTextNode(catty);
            var modal = document.getElementById('myModal');
            modal.style.display = 'none';
            $('.popupedit').attr('id', cattyid);
            $('.selectedcategorybuttonedit').text(catty);
        });

    $(document).ready(function() {
            gapi.load('auth2', function () {
                gapi.auth2.init();
            });
        });

    $(document).ready(function() {
        // $(".form2container").hide();
        $(".form2").hide();
        $(".profile-contentCenter").show('slow');
        $(".FollowersContainer").hide();
        $(".FollowingContainer").hide();
        $(".FollowedQuestionsContainer").hide();
        $(".AnsweredQuestionsContainer").hide();
        $(".profilePostAnswer").hide();
        $(".postscontainer").show();
    })
    $("#profile-PostButton").click(function() {
        $(".profile-contentCenter").show('slow');
        $(".FollowersContainer").hide();
        $(".FollowingContainer").hide();
        $(".FollowedQuestionsContainer").hide();
        $(".AnsweredQuestionsContainer").hide();
        $(".profile-contentRight").show('slow');
        $(".profile-contentLeft").show('slow');
        $(".profileCenterDiv").show('slow');
        $(".postscontainer").show('slow');
    })
    $("#profile-FollowersButton").click(function() {
        $(".profile-contentCenter").hide();
        $(".FollowersContainer").show('slow');
        $(".FollowingContainer").hide();
        $(".FollowedQuestionsContainer").hide();
        $(".AnsweredQuestionsContainer").hide();
        $(".profile-contentRight").hide();
        $(".profile-contentLeft").hide();
        $(".profileCenterDiv").hide();
    })
    $("#profile-FollowingButton").click(function() {
        $(".profile-contentCenter").hide();
        $(".FollowersContainer").hide();
        $(".FollowingContainer").show('slow');
        $(".FollowedQuestionsContainer").hide();
        $(".AnsweredQuestionsContainer").hide();
        $(".profile-contentRight").hide();
        $(".profile-contentLeft").hide();
        $(".profileCenterDiv").hide();
    })
    $("#profile-FollowedQuestionButton").click(function() {
        $(".profilePostAnswer").hide();
        $(".profile-contentCenter").show();
        $(".FollowersContainer").hide();
        $(".FollowingContainer").hide();
        $(".FollowedQuestionsContainer").show('slow');
        $(".AnsweredQuestionsContainer").hide();
        $(".profile-contentRight").show('slow');
        $(".profile-contentLeft").show('slow');
        $(".profileCenterDiv").show('slow');
        $(".postscontainer").hide();
    })
    $("#profile-AnsweredQuestionButton").click(function() {
        $(".profile-contentCenter").show('slow');
        $(".FollowersContainer").hide();
        $(".FollowingContainer").hide();
        $(".FollowedQuestionsContainer").hide();
        $(".AnsweredQuestionsContainer").show('slow');
        $(".profile-contentRight").show('slow');
        $(".profile-contentLeft").show('slow');
        $(".profileCenterDiv").show('slow');
    })
    $(document).ready(function() {
        $(".editprofilebutton").click(function() {
            $(".modal").fadeIn();
            $(".modal_main").show();
        });
    });
    $(document).ready(function() {
        $(".close").click(function() {
            $(".modal").fadeOut();
            $(".modal_main").fadeOut();
        });
    });

    function confirmDelete(id) {
        console.log("Clicked delete button");
            $.ajax({
                type: "DELETE",
                url: "http://iitoverflow.herokuapp.com/api/Questions/"+id,
                success: function (result) {
                    console.log('Successfully deleted question!');
                },
                error: function (result) {
                    console.log('Error in deleting question!');
                }
            });
        }
    
    $("#submitProfile").on("click", function(e) {
        console.log("Submit Profile button is clicked.");
        if (interests_list.length == 0) {
            console.log("Interests must not be empty!");
            return false;
        } else {
            e.preventDefault();
        var formdata = new FormData(); 
        var file = $('#avatar-1').prop('files');
        console.log(file);
        var name = $("#dispName").val();
        var names = $("#inter").val();
        var user = {
            "displayname": name
            //"interests": names
        };  
        console.log(JSON.stringify(user));
        $.ajax({
            url: "http://iitoverflow.herokuapp.com/api/users/{{curuser}}",
            type: "PATCH",
            data: JSON.stringify(user),
            dataType: "JSON",
            contentType: 'application/json',
            success: function(data2) {
                console.log("profile ", data2);
                $("#dispn").text(data2.displayname);
                if (file.length > 0) {
                    $.ajax({
                        url: "http://iitoverflow.herokuapp.com/api/users/{{curuser}}/updateProfile",
                        type: "POST",
                        data: {"picture": formdata.picture},
                        success: function() {
                            $("#profPic").attr("src", data.picture);
                        },
                        err: function() {
                            console.log("Error!");
                        }
                    });
                }
                if (formdata) {
                    formdata.append("file", file[0]);
                    console.log("formdata", formdata);
                    $.ajax({
                        url: "http://iitoverflow.herokuapp.com/api/users/{{curuser}}/updateProfile",
                        type: "POST",
                        data: formdata,
                        processData: false,
                        contentType: false,
                        success: function(data) {
                            //console.log("profile ", data.picture);
                            //console.log("profile ", data.picture);
                            console.log("TEST 1");
                            $("#profPic").attr("src", data.picture);
                            $("#modalProf").hide();
                        },
                        error: function(err) {
                            console.log("profile error :", err);
                        }
                    });
                    var userId = {{curuser}};
                    console.log("TEST 2: User Id: ", {{curuser}});
                    $.ajax({
                        url: "http://iitoverflow.herokuapp.com/api/users/"+userId+"/interests",
                        type: "DELETE",
                        data: JSON.stringify(user),
                        dataType: "json",
                        success: function (data3) {
                            console.log("interests are deleted")
                            interests_list.forEach(function(cat){
                                console.log(cat);
                                $.ajax({
                                url: "http://iitoverflow.herokuapp.com/api/users/"+userId+"/interests/rel/"+cat,
                                type: "PUT",
                                data: JSON.stringify({"userId": userId, "categoryId": cat}),
                                dataType: "json",
                                success: function (data3) {
                                    console.log("TEST 3");
                                    console.log("Success!");
                                    $("#int").text(data3.interests);
                                    console.log("Reload Interests");
                                    $("#interestscontainer").load(location.href + " #interestscontainer");
                                },
                                error: function(err) {
                                    console.log("profile error :", err);
                                }
                                });
                            });
                        },
                        error: function(err) {
                            console.log("profile error :", err);
                        }
                    });
                }
            }
        });
        $("#modalProf").hide();
        }
    });
   

</script>

<script>
    $(document).ready(function() {
        $(".call_modal").click(function() {
            $(".modal").fadeIn();
            $(".modal_main").show();
        });
    });
    $(document).ready(function() {
        $(".close").click(function() {
            $(".modal").fadeOut();
            $(".modal_main").fadeOut();
        });
    });
</script>

<script>
    $("#avatar-1").fileinput({
        overwriteInitial: true,
        maxFileSize: 1500,
        showClose: false,
        showCaption: false,
        browseLabel: '',
        removeLabel: '',
        browseIcon: '<i class="glyphicon glyphicon-folder-open"></i>',
        removeIcon: '<i class="glyphicon glyphicon-remove"></i>',
        removeTitle: 'Cancel or reset changes',
        elErrorContainer: '#kv-avatar-errors-1',
        msgErrorClass: 'alert alert-block alert-danger',
        defaultPreviewContent: '<img src="/static/images/default.png" alt="Your Avatar">',
        layoutTemplates: {
            main2: '{preview} ' + btnCust + ' {remove} {browse}'
        },
        allowedFileExtensions: ["jpg", "png", "gif"]
    });
</script>

<script type="text/javascript">
    var interests_list = [];
    {% for i in interests %}
        var id = "{{i.id}}";
        console.log(id);
        interests_list.push(id);
        console.log("Int IDs 1: " + interests_list + " IntList: " + interests_list.length);
    {% endfor %}
        console.log("Int IDs 2: " + interests_list + " IntList: " + interests_list.length);
    var interests_contain= document.getElementById("interest-contain");
    var category_contain = document.getElementById("category-contain");
    $(document).on('click', '.categorybuttons', function() {
        var categoryname = $(this).text();
        var categoryid = $(this).val();
        var text = document.createTextNode(categoryname);
        var btn = document.createElement("button");
        btn.setAttribute("class", "interestbuttons");
        btn.setAttribute("value", $(this).val());
        btn.appendChild(text);
        interests_contain.appendChild(btn);
        interests_list.push(categoryid);
        $(this).remove();
        console.log("Int IDs 3: " + interests_list + " IntList: " + interests_list.length);
    });


    $(document).on('click', '.interestbuttons', function() {
        var id = $(this).val();
        var index = interests_list.indexOf(id);
        // alert("Index in interests: " + index);
        if (index > -1) {
            interests_list.splice(index, 1);
        }
        // alert("List of ids: " + interests);
        categoryname = $(this).text();
        categoryid = $(this).val();
        text = document.createTextNode(categoryname);
        btn = document.createElement("button");
        btn.setAttribute("class", "categorybuttons");
        btn.setAttribute("value", categoryid);
        btn.appendChild(text);
        category_contain.appendChild(btn);
        console.log("Int IDs 4: " + interests_list + " IntList: " + interests_list.length);
        $(this).remove();
    });
</script>

<script>
    
        function followedQuestion(qid){
            $.ajax({
                type: "HEAD",
                async: true,
                url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/questionsfollowed/rel/'+qid,
                success: function(message){
                    $.ajax({
                        type: 'DELETE',
                        async: true,
                        url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/questionsfollowed/rel/'+qid,
                        success: function(message){
                            $('#followques_'+qid).text('Follow');
                            console.log('UNFOLLOWED');
                        },
                        error: function(message){
                            console.log(message);
                        }
                    });
                    $('#followques').text('Follow')
                },
                error: function(message){
                    console.log("FOLLOW QUESTION");
                        console.log("FOLLOW QUESTION");
                        $.ajax({
                            type: "PUT",
                            async: true,
                            url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/questionsfollowed/rel/'+qid,
                            success: function(message){
                                $('#followques_'+qid).text('Unfollow');
                                console.log('Followed');
                            }
                        });
                }

            });
        }
    function followedUser(uid){
            $.ajax({
                type: "HEAD",
                async: true,
                url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/following/rel/'+uid,
                success: function(message){
                    $.ajax({
                        type: 'DELETE',
                        async: true,
                        url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/following/rel/'+uid,
                        success: function(message){
                            $('#followuser_'+uid).text('Follow');
                            console.log('UNFOLLOWED');
                        },
                        error: function(message){
                            console.log(message);
                        }
                    });
                    $('#followuser_').text('Follow')
                },
                error: function(message){
                    console.log("FOLLOW QUESTION");
                        console.log("FOLLOW QUESTION");
                        $.ajax({
                            type: "PUT",
                            async: true,
                            url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/following/rel/'+uid,
                            success: function(message){
                                $('#followuser_'+uid).text('Unfollow');
                                console.log('Followed');
                            }
                        });
                }

            });
        }
            
    function followable(qid){
        
        $.ajax({
            type: "HEAD",
            async: true,
            url: 'http://iitoverflow.herokuapp.com/api/users/{{ curuser }}/following/rel/'+qid,
            success: function(message){
                $.ajax({
                    type: 'DELETE',
                    async: true,
                    url: 'http://iitoverflow.herokuapp.com/api/users/{{ curuser }}/following/rel/'+qid,
                    success: function(message){
                        $('#followa_'+qid).text('Follow');
                        console.log('UNFOLLOWED');
                    },
                    error: function(message){
                        console.log(message);
                    }
                });
                $('#followa_').text('Follow')
            },
            error: function(message){
                console.log("FOLLOW USER");
                    console.log("FOLLOW USERRRS");
                    $.ajax({
                        type: "PUT",
                        async: true,
                        url: 'http://iitoverflow.herokuapp.com/api/users/{{ curuser }}/following/rel/'+qid,
                        success: function(message){
                            $('#whotoFollow_'+qid).hide('slow');
                            $('#whotoFollow_'+qid).remove();
                            console.log('Followed');
                        }
                    });
            }
        });
    }


$(document).on('click', '#signout', function() {
    var auth2 = gapi.auth2.getAuthInstance();
    auth2.disconnect();
    auth2.signOut().then(function() {

        $.ajax({
            url: "http://localhost:5000/logout",
            dataType: "json",
            success: function(resp) {
                if (resp.message = "okay") {
                    window.location.replace('/');
                } else {
                    console.log("Something went wrong")
                }
            },
            error: function(e) {
                console.log('ERROR')
            }
        });
    });
});



$(".showallButton").click(function(){
        var id = $(this).attr("id");
        if($(this).text()=== "Show description"){
            $(this).text("Hide description");
            $("#show_"+id).show('slow');
        }
        else{
            $(this).text("Show description");
            $("#show_"+id).hide('slow');
        }
       
    });


        // $(".pencileditbutton").click(function() {
        //     var id = $(this).attr("id");
        //     if ($("#edit_" + id).is(":visible")) {
        //         $("#edit_" + id).hide();
        //         $("#editform_"+id).hide();
        //     }
        //     else {
        //         $("#edit_" + id).show();
        //         $("#editform_"+id).show();
        //     }
        // });

        function showhide(id) {
            if ($("#editform_" + id).is(":visible")) {
                // $("#edit_" + id).hide();
                $("#editform_"+id).hide();
            }
            else {
                // $("#edit_" + id).show();
                $("#editform_"+id).show();
            }
        }

        function CKupdate() {
            for (instance in CKEDITOR.instances) {
                CKEDITOR.instances[instance].updateElement();
                CKEDITOR.instances[instance].setData('');
            }
        }

        
        $(document).on('click', '.submitbutton5', function () {
            var qid = $(this).attr('id');
            var editorText = CKEDITOR.instances['editquestion_'+qid].getData();
            var posttitle = document.getElementById('titleedit').value;
            var gettags = document.getElementById('tagsIDedit').value;
            var cleartitle = document.getElementById('titleedit');
            var category = $('.popupedit').attr('id');
            var cleartags = document.getElementsByClassName('tag-editor-tag');
            console.log(cleartags);
            var data = {
                "question": posttitle,
                "questiondesc": editorText,
                "userId": "{{ curuser }}",
                "categoryId": category
            };
            $.ajax({
                type: "PUT",
                url: "https://iitoverflow.herokuapp.com/api/Questions/"+qid,
                data: JSON.stringify(data),
                dataType: "json",
                contentType: "application/json",
                success: function (result) {
                    console.log(result);
                    // alert('gaga');
                    qid = result.id;
                    //$('#qedit_' + qid).modal('toggle');
                    var tagslength = cleartags.length;
                    $.ajax({ 
                        type: "PUT",
                        url: "https://iitoverflow.herokuapp.com/api/Questions/"+qid,
                        data: JSON.stringify(data),
                        dataType: "json",
                        contentType: "application/json",
                        success: function (result) {
                            console.log(result);
                            $("#editform_"+qid).hide();
                            // alert('gaga');
                            qid = result.id;
                            //$('#qedit_' + qid).modal('toggle');
                            var tagslength = cleartags.length;
                            for (i = 0; i < tagslength; i++) {
                                var data1 = {
                                    "name": cleartags[i].innerText,
                                    "categoryId": category
                                };
                                console.log(cleartags[i].innerText);
                                // EDIT
                                $.ajax({
                                    type: "POST",
                                    url: "http://iitoverflow.herokuapp.com/api/Questions/" + qid + "/tags",
                                    data: JSON.stringify(data1),
                                    dataType: "json",
                                    contentType: "application/json",
                                    success: function (result1) {
                                        console.log(result1);
                                    },
                                    error: function (result1) {
                                        console.log(JSON.stringify(result1));
                                    }
                                });
                            }
                        }
                    });
                }
            });
        });
 ///////////////////////////////////////////////////////////////////////////////////
 var url = "https://iitoverflow.herokuapp.com/api/";
 // var url = "http://localhost:3000/api/";
 // var socketUrl = 'http://localhost:3000';
 var socketUrl = "https://iitoverflow.herokuapp.com";
 var user = {{ me_user | tojson}};
 console.log(user);
 var socketUser = "{{ me_user.id |safe}}";
 ///////////////////////////////////////////////////////////////////////////////////
 //var socketUser =2;
 var questionFollowing = {{me_following_questions |tojson}};
 var userFollowing = {{me_followed | tojson}};
 var interests = {{me_interests | tojson}};
///////////////////////////////////////////////////////////////////////////////////
$(document).ready(function() {

     
 
 var oldnotifs = {{me_notifications|tojson}};
 oldnotifs.forEach(element => {
 if(element.type == 'newQuestion'){
     
     var holdNewQuestionHtml =
         '<li><a href="/Question/' + element.question.id +
         '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
             element.user.picture +
         '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;"><strong class="text-info">' +
                 element.user.displayname + '</strong> posted a new Question: ' + element.question.question +
         '<div><small class="text-warning">' + getDate(element.question.createdAt) +
         '</small> </div></div> </div></a></li>';
     $("#notification-content").append(holdNewQuestionHtml);

 }else if(element.type == 'newAnswer'){

     var holdNewAnswerHtml = "";
     if (element.question.userId == socketUser) {
         holdNewAnswerHtml +=
             '<li><a href="/Question/' + element.question.id +
             '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
                 element.user.picture +
             '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8"><strong class="text-info">' +
                 element.user.displayname + '</strong> answered your question: ' + element.answer.answer +
             '<div><small class="text-warning">' + getDate(element.answer.createdAt) +
             '</small> </div></div> </div></a></li>';

         $("#notification-content").append(holdNewAnswerHtml);
     } else if ($.grep(questionFollowing, function(obj) {
             return obj.id === element.question.id;
         })[0]) {
         holdNewAnswerHtml +=
             '<li><a href="/Question/' + element.question.id +
             '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
                 element.user.picture +
             '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8"><strong class="text-info">' +
                 element.user.displayname + '</strong> answered a question you\'re following: ' + element.answer.answer +
             '<div><small class="text-warning">' + getDate(element.answer.createdAt) +
             '</small> </div></div> </div></a></li>';

         $("#notification-content").append(holdNewAnswerHtml);
     }

 }else if(element.type == 'newComment'){
     holdNewAnswerHtml +=
             '<li><a href="/Question/' + element.question.id +
             '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
                 element.user.picture +
             '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8"><strong class="text-info">' +
                 element.user.displayname + '</strong> commented on your answer: ' + element.comment.comment +
             '<div><small class="text-warning">' + getDate(element.comment.createdAt) +
             '</small> </div></div> </div></a></li>';

         $("#notification-content").append(holdNewAnswerHtml);


 }
 
 });
 reloadchatlist();
});
</script>

<script>
///////////////////////////////////////////////////////////////////////////////////
const chatSocket = io(socketUrl + '/chat');
 const notificationSocket = io(socketUrl + '/notification');


 chatSocket.on('connection', function(socket) {


     //console.log("connected");

 });
 chatSocket.on('wentOffline', function(data) {
     $("#user_" + data.user + "_status").attr("class", "");

     //console.log(data.user, " is now offline");
 });
 chatSocket.on('wentOnline', function(data) {
     $("#user_" + data.user + "_status").attr("class", "contact-status online");

     //console.log(data.user, " is now online");
 });
 notificationSocket.on('newQuestion', function(data) {
     //console.log("New Question");
     //console.log(data);
     console.log("NewQuestion",data);
     var holdNewQuestionHtml = "";
     if (data.question.userId != socketUser)
         if ($.grep(userFollowing, function(obj) {
                 return obj.id === data.question.userId;
             })[0] || $.grep(interests, function(obj) {
                 return obj.id === data.question.categoryId;
             })[0]) {
             holdNewQuestionHtml +=
                 '<li><a href="/Question/' + data.question.id +
                 '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
                 data.user.picture +
                 '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8"><strong class="text-info">' +
                 data.user.displayname + '</strong> posted a new Question: ' + data.question.question +
                 '<div><small class="text-warning">' + "Just now" +
                 '</small> </div></div> </div></a></li>';
             $("#notification-content").prepend(holdNewQuestionHtml);

         }
 });
 notificationSocket.on('newAnswer', function(data) {
     console.log("NewAnswer",data);
     var holdNewAnswerHtml = "";
     if (data.answer.userId != socketUser)
     if (data.question.userId == socketUser) {
         holdNewAnswerHtml +=
             '<li><a href="/Question/' + data.question.id +
             '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
             data.user.picture +
             '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8"><strong class="text-info">' +
             data.user.displayname + '</strong> answered your question: ' + data.answer.answer +
             '<div><small class="text-warning">' +"Just now"+
             '</small> </div></div> </div></a></li>';

         $("#notification-content").prepend(holdNewAnswerHtml);
     } else if ($.grep(questionFollowing, function(obj) {
             return obj.id === data.question.id;
         })[0]) {
         holdNewAnswerHtml +=
             '<li><a href="/Question/' + data.question.id +
             '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
             data.user.picture +
             '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8"><strong class="text-info">' +
             data.user.displayname + '</strong> answered a question you\'re following: ' + data.answer.answer +
             '<div><small class="text-warning">' + "Just now" +
             '</small> </div></div> </div></a></li>';

         $("#notification-content").prepend(holdNewAnswerHtml);
     }

     //console.log("New Answer");
     //console.log(data);
 });
 notificationSocket.on('newComment', function(data) {
     console.log("NewComment",data);
     var holdNewAnswerHtml = "";
     if (data.answer.userId == socketUser && data.comment.userId != socketUser) {
         holdNewAnswerHtml +=
             '<li><a href="/Question/' + data.question.id +
             '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
             data.user.picture +
             '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8"><strong class="text-info">' +
             data.user.displayname + '</strong> commented on your answer: ' + data.comment.comment +
             '<div><small class="text-warning">' + "Just now" +
             '</small> </div></div> </div></a></li>';

         $("#notification-content").prepend(holdNewAnswerHtml);
     }
     //console.log("New Comment");
     //console.log(data);
 });
 chatSocket.on('message', function(data) {
     
     console.log("newMessage",data);

     m_pic = data.user.picture;
     if(!($("#unread_solo_" + data.message.conversationId).length)){
         openConversation(data.message.senderId);

     }else if (popups.indexOf("solo_" + data.message.conversationId) > -1) {


         var m_element =
             '<div class="row msg_container base_receive"><div class="col-md-2 col-xs-2 avatar"><img src="' +
             m_pic +
             '" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive"><p>' +
             data.message.message +
             '</p><time style ="text-align:left;" datetime="2009-11-13T20:00">' +
             data.user.displayname +
             '</time></div></div></div>';

         $("#m_solo_" + data.message.conversationId).append(m_element);



         var panel = $("#m_solo_" + data.message.conversationId);
         //$('#m_'+id).animate({scrollTop: $('#m_'+id).get(0).scrollHeight}, 700);
         $("#m_solo_" + data.message.conversationId).scrollTop($(
                 "#m_solo_" + data.message.conversationId).get(0)
             .scrollHeight);
     } else if ($("#unread_solo_" + data.message.conversationId).length) {
         if ($("#unread_solo_" + data.message.conversationId).html() == '') {
             $("#unread_solo_" + data.message.conversationId).html("1");
         } else {
             var holdValue = parseInt($("#unread_solo_" + data.message.conversationId).html());
             //console.log(holdValue++);
             $("#unread_solo_" + data.message.conversationId).html(holdValue);
         }
     }
 });
 chatSocket.emit("connected", {
     id: socketUser
 });
 sendMessage2 = function() {
     ////console.log($("#message").val());
     chatSocket.emit("messageSent", $("#message").val());

 }

 getDate = function(date) {

     var date2 = new Date().getTime() - new Date(date).getTime();

     var seconds = Math.floor(date2 / 1000);

     if (Math.floor(seconds / 3600) >= 24)
         return new Date(date).toUTCString();

     if (Math.floor(seconds / 3600))
         return "" + Math.floor(seconds / 3600) + " hours ago";

     if (Math.floor(seconds / 60))
         return "" + Math.floor(seconds / 60) + " minutes ago";

     if (Math.floor(seconds / 1))
         return "" + Math.floor(seconds / 1) + " seconds ago";

     return "Just now";
     return new Date(date).toUTCString();



 }

///////////////////////////////////////////////////////////////////////////////////
</script>

<script type="text/javascript">
 ///////////////////////////////////////////////////////////////////////////////////
 //var url = "http://localhost:3000/api/";
 function isOnline(online, id) {
     console.log("online: ", online);
     return (online ? '<span id="user_' + id + '_status" class="contact-status online"></span>' : '<span id="user_' + id + '_status"></span>');
 }
 ///////////////////////////////////////////////////////////////////////////////////
 function openConversation(id){
     $.ajax({
         url: url + "users/" + socketUser + "/getconversation/"+id,
         method: 'get',
         dataType: "JSON",
         headers: {
             'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
         },
         success: function(data) {
             //console.log(data);
             var convolist = data;
             var convoStore = "";
             var profilepic;
             if($("#unread_"+convolist.id).length){
                 register_popup(convolist.id,convolist.displayname);
             }else{
                 profilepic = convolist.profilepic;
                 convoStore += '<div class="sidebar-name " onclick="javascript:register_popup( \'' +
                     convolist.id + '\',\'' + convolist.displayname +
                     '\');"> <div class="convoName"><a class="wrap"style="position: relative;">' + isOnline(convolist.online, convolist.userid) + '<img class="img-circle" width="30" height="30" src="' +
                     profilepic + '" /><span>' + convolist.displayname + '</span>';

                 // if (convolist[i].unread > 0) {
                 convoStore += '<span id="unread_' + convolist.id +
                     '" style="position: absolute;bottom: -2px;left: -2px;"  class="label label-danger">' +
                     (convolist.unread == 0 ? '' : convolist.unread) + '</span>';
                 //}


                 convoStore += '</a></div></div>';
             

                 $("#convos").prepend(convoStore);
                 register_popup(convolist.id,convolist.displayname);
             }


                 
             
         },
         error: function(data) {}
     });

 }
 ///////////////////////////////////////////////////////////////////////////////////
 function reloadchatlist() {
     $.ajax({
         url: url + "users/" + socketUser + "/chatlist",
         method: 'get',
         dataType: "JSON",
         headers: {
             'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
         },
         success: function (data) {
             console.log(data);
             var convolist = data;
             var convoStore = "";
             var profilepic;
             for (var i = 0; i < convolist.length; i++) {
                 profilepic = convolist[i].profilepic;
                 convoStore += '<div class="sidebar-name " onclick="javascript:register_popup( \'' +
                     convolist[i].id + '\',\'' + convolist[i].displayname +
                     '\');"> <div class="convoName"><a class="wrap"style="position: relative;">' + isOnline(convolist[i].online, convolist[i].userid) + '<img class="img-circle" width="30" height="30" src="' +
                     profilepic + '" /><span>' + convolist[i].displayname + '</span>';
                 // if (convolist[i].unread > 0) {
                 convoStore += '<span id="unread_' + convolist[i].id +
                     '" style="position: absolute;bottom: -2px;left: -2px;"  class="label label-danger">' +
                     (convolist[i].unread == 0 ? '' : convolist[i].unread) + '</span>';
                 //}
                 convoStore += '</a></div></div>';
                 
             }
             $("#convos").html(convoStore);
             return true;
         },
         error: function (data) { 
             return false;
         }

     });
     
 }
///////////////////////////////////////////////////////////////////////////////////

</script>

<script type="text/javascript" charset="utf-8" async defer>
 ///////////////////////////////////////////////////////////////////////////////////
 $(document).ready(function () {
     var chatHtml = '<div class="container sideChatContainer">' +
         '<div id="sideChat">' +
         '<div id="sideChatHeader" type="button" class="btn btn-primary chatBtn" data-toggle="collapse" data-target="#chatBody" style="display: inline-flex;">' +
         '<div style="width: 200px;">' +
         '<label  id="chatLabel" style="float:left;padding-left:10px;padding-top: 2px;">Chat </label>' +
         '</div>' +
         '<div >' +
         '<!--<a  id = "optionBtn" role="button" class="glyphicon glyphicon-cog button" data-target="Options" data-toggle="collapse2" data-hover="tooltip" data-tooltip-content="Options" data-tooltip-position="below" style="font-size: 15px;text-decoration: none;"></a>-->' +
         '</div>' +
         '</div>' +
         '<div id="chatBody" class="collapse">' +
         '<div id="convos" class="chat-sidebar tabcontent convos" style="padding-top: 2px;overflow-y: scroll;">' +
         '</div> </div></div></div>';
     $("#sideChat").replaceWith(chatHtml);
     $('.chatBody').collapse();
     reloadchatlist();
 });
///////////////////////////////////////////////////////////////////////////////////
$(document).on('click','#sideChatHeader', function(e){
 reloadchatlist();
});
</script>

<script type="text/javascript">
 ///////////////////////////////////////////////////////////////////////////////////
 $('#optionBtn').click(function (e) {
     e.stopPropagation();
 });
 ///////////////////////////////////////////////////////////////////////////////////
 function openTab(evt, tabName) {
     // Declare all variables
     var i, tabcontent, tablinks;
     // Get all elements with class="tabcontent" and hide them
     tabcontent = document.getElementsByClassName("chat-sidebar");
     for (i = 0; i < tabcontent.length; i++) {
         tabcontent[i].style.display = "none";
     }
     // Get all elements with class="tablinks" and remove the class "active"
     tablinks = document.getElementsByClassName("tablinks");
     for (i = 0; i < tablinks.length; i++) {
         tablinks[i].className = tablinks[i].className.replace(" active", "");
     }
     // Show the current tab, and add an "active" class to the button that opened the tab
     document.getElementById(tabName).style.display = "block";
     evt.currentTarget.className += " active";
 }
 ///////////////////////////////////////////////////////////////////////////////////
 $(document).ready(function () {
     $('.chatBody').collapse();
 });
///////////////////////////////////////////////////////////////////////////////////
</script>

<script type="text/javascript">
 ///////////////////////////////////////////////////////////////////////////////////
 var m_pic;
 var m_id;
 var m_element
 $(document).ready(function () {
     if (popups.length > 0) {
         $.ajax({
             url: "/updateChat",
             method: "GET",
             data: {
                 id: popups
             },
             dataType: "JSON",
             headers: {
                 'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
             },
             success: function (data) {
                 //console.log(data);
                 if (data.length != 0) {
                     //console.log(popups);
                     //console.log(data[0].id)
                     for (var i = 0; i < data.length; i++) {
                         if (data[i].profilePic != null) {
                             m_pic = "/avatar/" + data[i].profilePic;
                         } else {
                             m_pic =
                                 "http://www.bitrebels.com/wp-content/uploads/2011/02/Original-Facebook-Geek-Profile-Avatar-1.jpg";
                         }
                         if (popups.indexOf("solo_" + data[i].conversationId) > -1) {
                             m_element =
                                 '<div class="row msg_container base_receive"><div class="col-md-2 col-xs-2 avatar"><img src="' +
                                 m_pic +
                                 '" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive"><p>' +
                                 data[i].message +
                                 '</p><time style ="text-align:left;" datetime="2009-11-13T20:00">' +
                                 data[i].firstname + ' ' + data[i].lastname +
                                 '</time></div></div></div>';
                             $("#m_solo_" + data[i].conversationId).append(m_element);
                             var panel = $("#m_solo_" + data[i].conversationId);
                             //$('#m_'+id).animate({scrollTop: $('#m_'+id).get(0).scrollHeight}, 700);
                             $("#m_solo_" + data[i].conversationId).scrollTop($(
                                 "#m_solo_" + data[i].conversationId).get(0)
                                 .scrollHeight);
                         }
                     }
                 }
             },
             error: function (data) {
             }
         });
     }
     //code goes here that will be run every 5 seconds.
 });
///////////////////////////////////////////////////////////////////////////////////
</script>
<script type="text/javascript">
 ///////////////////////////////////////////////////////////////////////////////////
 function urlify(text) {
     var urlRegex = /(((https?:\/\/)|(www\.))[^\s]+)/g;
     //var urlRegex = /(https?:\/\/[^\s]+)/g;
     return text.replace(urlRegex, function (url, b, c) {
         var url2 = (c == 'www.') ? 'http://' + url : url;
         return '<a href="' + url2 + '" target="_blank">' + url + '</a>';
     })
 }
 ///////////////////////////////////////////////////////////////////////////////////
 function sendMessage($id, $message, $this, $message_panel) {
     if ($message != '') {
         $this.parents('.popup-box').find('.chat_input').val('');
         $.ajax({
             url: url + "users/" + socketUser + "/conversation/" + $id.split("_")[1],
             method: "POST",
             data: {
                 msg: $message
             },
             dataType: "JSON",
             headers: {
                 'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
             },
             success: function (data) {
                 var $element = '';
                 var profilepic;
                 profilepic = user.picture;
                 $element += '<div id="' + data.id +
                     '"  class="row msg_container base_sent"><div class="col-md-10 col-xs-10"><div class="messages msg_sent"><p>';
                 $element += $message;
                 $element +=
                     '</p><time class ="time"datetime="2009-11-13T20:00">You</time></div></div><div class="col-md-2 col-xs-2 avatar"><img src="' +
                     profilepic + '" class=" img-responsive "></div></div>';
                 $hold = $($element);
                 $message_panel.append($hold);
                 //$message_panel.animate({ scrollTop: $(element).offset().top }, 1000);
                 $message_panel.animate({
                     scrollTop: $message_panel.get(0).scrollHeight
                 }, 700);
             },
             error: function (data) {
             }
         });
     }
 }
 ///////////////////////////////////////////////////////////////////////////////////
 $(document).on('keyup', '.chat_input', function (e) {
     if (e.which === 13) {
         //return sendMessage(getMessageText());
         var $this = $(this);
         var $message = urlify($this.parents('.popup-box').find('.chat_input').val().trim());
         var $message_panel = $this.parents('.popup-box').find('.popup-messages');
         var $id = $this.parents('.popup-box').attr('id');
         sendMessage($id, $message, $this, $message_panel)
     }
 });
 ///////////////////////////////////////////////////////////////////////////////////
 $(document).on('click', '.popup-box button.btn-chat', function (e) {
     var $this = $(this);
     var $message = urlify($this.parents('.popup-box').find('.chat_input').val().trim());
     var $message_panel = $this.parents('.popup-box').find('.popup-messages');
     var $id = $this.parents('.popup-box').attr('id');
     sendMessage($id, $message, $this, $message_panel);
 });
 ///////////////////////////////////////////////////////////////////////////////////
 $(document).on('click', '.panel-heading span.icon_minim', function (e) {
     var $this = $(this);
     if (!$this.hasClass('panel-collapsed')) {
         $this.parents('.popup-box').find('.message_body').slideUp();
         $this.addClass('panel-collapsed');
         $this.removeClass('glyphicon-minus').addClass('glyphicon-plus');
     } else {
         $this.parents('.popup-box').find('.message_body').slideDown();
         $this.removeClass('panel-collapsed');
         $this.removeClass('glyphicon-plus').addClass('glyphicon-minus');
     }
 });
 ///////////////////////////////////////////////////////////////////////////////////
 //this function can remove a array element.
 Array.remove = function (array, from, to) {
     var rest = array.slice((to || from) + 1 || array.length);
     array.length = from < 0 ? array.length + from : from;
     return array.push.apply(array, rest);
 };
 ///////////////////////////////////////////////////////////////////////////////////
 //this variable represents the total number of popups can be displayed according to the viewport width
 var total_popups = 0;
 //arrays of popups ids
 var popups = [];
 //this is used to close a popup
 function close_popup(id) {
     for (var iii = 0; iii < popups.length; iii++) {
         if (id == popups[iii]) {
             Array.remove(popups, iii);
             document.getElementById('b_' + id).style.display = "block";
             document.getElementById(id).style.display = "none";
             //$("#"+id).remove();
             $("#" + id + " span.icon_minim").removeClass('glyphicon-plus').addClass('glyphicon-minus');
             calculate_popups();
             return;
         }
     }
 }
 ///////////////////////////////////////////////////////////////////////////////////
 //displays the popups. Displays based on the maximum number of popups that can be displayed on the current viewport width
 function display_popups() {
     var right = 330;
     var iii = 0;
     for (iii; iii < total_popups; iii++) {
         if (popups[iii] != undefined) {
             var element = document.getElementById(popups[iii]);
             element.style.right = right + "px";
             right = right + 280;
             element.style.display = "block";
         }
     }
     for (var jjj = iii; jjj < popups.length; jjj++) {
         var element = document.getElementById(popups[jjj]);
         element.style.display = "none";
     }
 }
 ///////////////////////////////////////////////////////////////////////////////////
 //creates markup for a new popup. Adds the id to popups array.
 function register_popup(id, name) {
     for (var iii = 0; iii < popups.length; iii++) {
         //already registered. Bring it to front.
         if (id == popups[iii]) {
             Array.remove(popups, iii);
             popups.unshift(id);
             calculate_popups();
             return;
         }
     }
     var element = '<div class="popup-box chat-popup" id="' + id + '" > ';
     element = element + '<div class="panel-heading popup-head" >';
     element = element + '<div class="popup-head-left">' + name + '</div>';
     element = element +
         '<div class="popup-head-right"><a ><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a><a href="javascript:close_popup(\'' +
         id + '\');">&#10005;</a></div>';
     element = element + '<div style="clear: both"></div></div><div id="b_' + id + '" class="message_body ' + id +
         '" ><div id="m_' + id + '" class="popup-messages">';
     element +=
         '</div><div class="input-group" style="padding-top:4px;padding-bottom:4px;"><input id="btn-input" class="form-control input-sm chat_input" placeholder="Write your message here..." type="text" style="float:bottom"><span class="input-group-btn"><button class="btn-chat btn btn-primary btn-sm">Send</button> </span></div></div></div>';
     // Insert msg body
     document.getElementsByTagName("body")[0].innerHTML = document.getElementsByTagName("body")[0].innerHTML +
         element;
     popups.unshift(id);
     calculate_popups();
     $.ajax({
         url: url + "/users/" + socketUser + "/conversation/" + id.split("_")[1],
         method: "GET",
         headers: {
             'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
         },
         success: function (data) {
             var element = '';
             data = data;
             var pic;
             for (var i = 0; i < data.length; i++) {
                 var $messageData = data[i];
                 pic = $messageData.picture;
                 console.log("message", $messageData);
                 console.log("sender: ", $messageData.senderid, " user: ", socketUser);
                 if ($messageData.senderid == socketUser) {
                     element +=
                         '<div class="row msg_container base_sent"><div class="col-md-10 col-xs-10"><div class="messages msg_sent"><p>' +
                         $messageData.message +
                         '</p><time datetime="2009-11-13T20:00">You</time></div></div><div class="col-md-2 col-xs-2 avatar"><img class="chatvatar" src="' +
                         pic + '" class=" img-responsive "></div></div>';
                 } else {
                     element +=
                         '<div class="row msg_container base_receive"><div class="col-md-2 col-xs-2 avatar"><img src="' +
                         pic +
                         '" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive"><p>' +
                         $messageData.message +
                         '</p><time style ="text-align:left;" datetime="2009-11-13T20:00">' + $messageData.displayname + '</time></div></div></div>';
                 }
             }
             $("#m_" + id).empty();
             $("#m_" + id).append(element);
             var panel = $('#m_' + id);
             //$('#m_'+id).animate({scrollTop: $('#m_'+id).get(0).scrollHeight}, 700);
             $('#m_' + id).scrollTop($('#m_' + id).get(0).scrollHeight);
         },
         error: function (data) {
         }
     });
     document.getElementById(id).style.display = "block";
     $("#unread_" + id).html('');
 }
 ///////////////////////////////////////////////////////////////////////////////////
 //calculate the total number of popups suitable and then populate the toatal_popups variable.
 function calculate_popups() {
     var width = window.innerWidth;
     if (width < 540) {
         total_popups = 0;
     } else {
         width = width - 200;
         //320 is width of a single popup box
         total_popups = parseInt(width / 320);
     }
     display_popups();
 }
 ///////////////////////////////////////////////////////////////////////////////////
 //recalculate when window is loaded and also when window is resized.
 window.addEventListener("resize", calculate_popups);
 window.addEventListener("load", calculate_popups);
 ///////////////////////////////////////////////////////////////////////////////////
 $(".profilePostAnswerButton").click(function(){
    var id = $(this).attr("id");
    if($(this).text()=== "View Answer"){
        console.log("Show answer");
        $("#ProfilepostAnswerDiv_"+ id).show('slow');
        $("#ProfilepostAnswerBox_"+ id).show('slow');
        $("#ProfilepostCommentBox_"+ id).show('slow');        
        $(this).text("Hide Answer");
    }
    else {
        console.log("Hide answer");
        $(this).text("View Answer");
        $("#ProfilepostAnswerDiv_"+ id).hide('slow');
        $("#ProfilepostAnswerBox_"+ id).hide('slow');
        $("#ProfilepostCommentBox_"+ id).hide('slow');  
        
    }
   
 });
</script>

<!-- $(".showallButton").click(function(){
    var id = $(this).attr("id");
    if($(this).text()=== "Show description"){
        $(this).text("Hide description");
        $("#show_"+id).show('slow');
    }
    else{
        $(this).text("Show description");
        $("#show_"+id).hide('slow');
    } -->
   
});
</html>