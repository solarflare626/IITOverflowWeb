<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" media="screen" href="../static/css/mainprofile.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script src="../static/js/mainprofile.js"></script>


    <meta name="google-signin-scope" content="">
    <meta name="google-signin-client_id" content="976545483152-3u1fctn90tf0qvjevud1hkfu3jdneog0.apps.googleusercontent.com">
    <meta name="google-signin-client_secret" content="dhayVHWZ-OsnjdQO47qZXhOD">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    
    <link href="../static/css/sideChat.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.0/socket.io.js"></script>
</head>

<body>
    <!-- <div class="Profile-hider" id="hider">

    </div> -->
    <div class="profile-fullpage">


        <!-- <div class="profile-popup_box1" id="popup_box1">
            Message
            <br />
            <a id="buttonClose">Close</a>
        </div> -->

        <div class="profile-section">
            <div class="profile-landing">

                <div class="profile-nav">
                    <div class="profile-search">

                        <button class="profile-searchbutton" type="submit">
                            <span class="glyphicon glyphicon-search">
                        </button>
                        <input class="profile-searchbar" type="text" placeholder="Search..">

                    </div>
                    <div class="profile-pages">

                        <a href="{{ url_for('.question') }}"><span class="glyphicon glyphicon-home"></span>  Home</a>
                        <a href="{{ url_for('.profile', id=curuser)}}"><span class="glyphicon glyphicon-user"></span>  Profile</a>
                        <a href="#"><span class="glyphicon glyphicon-bell"></span>  Notifications</a>
                        <a href="" onclick="signOut();return false;"><span class="glyphicon glyphicon-asterisk"></span> Logout</a>

                    </div>
                </div>
                <div class="profile-contentTop">
                    <div class="profile-contentTopCover">
                        <img src="../static/image/background1.jpg" alt="    over">
                        <div class="profilepictureContainer">
                            <img id="profPic" src="{{ json_object.picture }}" alt="Profilepic">
                        </div>
                    </div>
                    <div class="profile-contentTopLinks">
                        <div class="profile-contentTopNav">
                            {% block body %}
                            <a type="submit" id="profile-PostButton"> {{questions}} Posts</a>
                            <a type="submit" id="profile-FollowersButton">{{followers}} Followers</a>
                            <a type="submit" id="profile-FollowingButton">{{following}} Following</a>
                            <a type="submit" id="profile-FollowedQuestionButton">{{questionsfollowed}} Followed Questions</a>
                            <!-- <a type="submit" id="profile-AnsweredQuestionButton">{{answers}} Answered Questions</a>  -->
                            {% if s_code == 404%}
                            <button id="followus" class="unfollow">
                                <a class="msg-follow followbutton" id ="followusText" >Follow</a>
                            </button> {%else%}
                            <button id="followus" class="unfollow">
                                <a class="msg-follow followbutton" id= "followusText">Unfollow</a>
                            </button> {%endif%} {% endblock %}
                            <a class="messageprofile" style="cursor:pointer;" onclick="openConversation({{user | safe}})">Message</a>
                        </div>

                    </div>



                </div>
                <div class="CenterLeftRightCont" style="margin-top: 400px;">
                   <div class="profile-contentLeft">

                                <!-- <h4>Bio info here</h4> -->
                                <p style="font-weight: 1000; font-size: 22px" id="dispn"> {{ json_object['displayname'] }} </p>
                                <a class="profilePostEmail"> {{json_object.email}} </a>
                                <div class="profile-linksInterest" id="interestscontainer">
                                   <div  style="background-color: white; padding: 10px; color:#801515;">
                                    <h4> Interests</h4>
                                    <br> {% for interest in json_object.interests %}
                                    <a style="border:1px solid black" id="int"> {{interest.name}} </a>
                                    {% endfor %}

                                   </div>
                                </div>
                            </div>


                    <div class="profileCenterDiv">
                            <div class="FollowedQuestionsContainer">
                                    {% for question in followed_questions|reverse %}
                                    <div class="profile-contentCenter">
                                        <div class="profilePostPictureCont">
                                            <img class="profilePostPicture" src="{{ question.user.picture }}">

                                        </div>
                                        <div class="profileNameEmail">
                                            <a class="profilePostUsername">{{question.user.displayname}}</a>
                                            <a class="profilePostEmail">{{question.user.email}}</a>
                                            <h3 class="profilePostTitle">Title:{{ question.question|safe }} <a class="showallButton" type="button" title="Show all"  id="{{question.id}}">Show description</a></h3>
                                        </div>

                                        <br>

                                        <div class="profilePostAnswer" id={{"show_{0}".format(question.id)}}>{{ question.questiondesc|safe }}</div>
                                       
                                        <hr>                                        
                                        <div class="profilePostButton">
                                                <button  onclick = "followedQuestion('{{question.id}}')" >
                                                        <a href="#"  id={{"followques_{0}".format(question.id)}} class="profilePostFollowButton">Unfollow</a>
                                                    </button>
                                            <a href="#" class="glyphicon glyphicon-pencil"></a>
                                            <a href="#" class="glyphicon glyphicon-comment"></a>
                                            <a onclick="upvote('{{question.id}}')" class="glyphicon glyphicon-thumbs-up" id="QupVote"> </a>
                                            <a onclick="downvote('{{question.id}}')" class="glyphicon glyphicon-thumbs-down" id= "QdownVote"> </a>
                                            
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                        <div class="AnsweredQuestionsContainer">
                            {% for question in answered_questions|reverse %}
                            <div class="profile-contentCenter">
                                <div class="profilePostPictureCont">
                                    <img class="profilePostPicture" src="../static/image/google.png">
                                </div>
                                <div class="profileNameEmail">
                                    <a class="profilePostUsername">{{question.user.displayname}}</a>
                                    <a class="profilePostEmail">{{question.user.email}}</a>
                                    <h3 class="profilePostTitle">Title:{{ question.question | safe}}<a class="showallButton" type="button" title="Show all"  id="{{question.id}}">Show description</a></h3>
                                </div>
                                <div class="profilePostAnswer" id={{"show_{0}".format(question.id)}}>{{ question.questiondesc | safe }}</div>
                                <div>{{ question.answer }}</div>
                                <div class="profilePostButton">
                                        <button  onclick = "followedQuestion('{{question.id}}')" >
                                                <a href="#"  id={{"followques_{0}".format(question.id)}} class="profilePostFollowButton">Unfollow</a>
                                            </button>
                                    <a href="#" class="glyphicon glyphicon-pencil"></a>
                                    <a href="#" class="glyphicon glyphicon-comment"></a>
                                    <a onclick="upvote('{{question.id}}')" class="glyphicon glyphicon-thumbs-up" ></a>
                                    <a onclick="downvote('{{question.id}}')" class="glyphicon glyphicon-thumbs-down"></a>
                                   
                                </div>
                            </div>
                            {% endfor %}
                        </div>


                        {% for i in json_object.questions|reverse %}

                        <div class="profile-contentCenter" id="{{i.id}}">
                            <div class="profilePostPictureCont">
                                <img class="profilePostPicture" src="{{json_object.picture}}">

                            </div>
                            <div class="profileNameEmail">
                                <a class="profilePostUsername">{{json_object.displayname}}</a>
                                <a class="profilePostEmail">{{json_object.email}}</a>
                                <h3 class="profilePostTitle">Title:{{i.question | safe}} <a class="showallButton" type="button" title="Show all"  id="{{json_object.id}}">Show description</a> </h3>
                            </div>

                            <br>

                            <p class="profilePostAnswer" [innerHTML] = "i.questiondesc"></p>
                            <div class="profilePostButton">
                                    <button  onclick = "followedQuestion('{{i.id}}')" >
                                            <a href="#"  id={{"followques_{0}".format(i.id)}} class="profilePostFollowButton">Unfollow</a>
                                        </button>
                                <a href="#" class="glyphicon glyphicon-comment"></a>
                                <a onclick="upvote('{{i.id}}')" class="glyphicon glyphicon-thumbs-up" ></a>
                                <a onclick="downvote('{{i.id}}')" class="glyphicon glyphicon-thumbs-down"></a>
                               
                            </div>

                        </div>
                        {% endfor %}
                    </div>
                    <div>
                        <a href=" "> </a>
                    </div>
                    <div class="FollowersContainer">
                        
                            {% for follower in json_object1.followers %}
                            <div class="FollowersRow">
                            
                            <div class="col-md-2 col-sm-6">
                                    <a href="{{ url_for('.profile', id = follower.id) }}">
                                <div class="our-team">
                                    <div class="FollowersPic">
                                        <img src="{{ follower.picture }}">
                                        <div class="team-content">
                                            <h3 class="FollowersTitle">{{ follower.displayname }}</h3>
                                        </div>
                                    </div>
                                    <ul class="social">
                                            <button  onclick = "followedUser('{{follower.id}}')" >
                                                    <a style="color: white;" href="#"  id={{"followuser_{0}".format(follower.id)}} class="followerButton">Unfollow</a>
                                                </button>
                                    </ul>
                                </div>
                            </div>
                        </a>
                            {% endfor %}
                        </div>
                    </div>


                    <div class="profile-contentRight">
                            <div style="background-color: white; padding: 10px;">
                            <h4 style="text-align: left; color: #801515">Who to Follow</h4>
                                {% for i in whotofollowusers %}
                                 <div class="whotoFollowss" id= {{"whotoFollow_{0}".format(i.id)}}>
                                    <!-- <div class="whotoFollowss" id= "{{ i.displayname }}"> -->
                                <div class="picturess">
                                    <img class="profileimagess" src="{{ i.picture }}">
                                </div>
            
                                <button  onclick = "followable('{{i.id}}')" class="whotofollowButtonss">
                                    <a href="#"  id={{"followa_{0}".format(i.id)}} >Follow</a>
                            </button>
                                <div class="whotoFollowNamess">
                                    <a href="{{ url_for('.profile', id = i.id) }}" >{{ i.displayname }}</a>

                                    <a>{{ i.email }}</a>
                                </div>
            
                            </div>
                            {% endfor %}
            
            
                             <a>
                                <h4>See all</h4>
                            </a>
                    

                    <div class="FollowingContainer">

                            {% for g in json_object1.following %}
                            <div class="FollowersRow">
                            <a href="{{ url_for('.profile', id = g.id) }}">
                            <div class="col-md-2 col-sm-6">
                                <div class="our-team">
                                    <div class="FollowersPic">
                                        <img src="{{ g.picture }}">

                                        <div class="team-content">
                                            <h3 class="FollowersTitle">{{g.displayname}}</h3>
                                            <span class="FollowersPost">Web Developer</span>
                                        </div>
                                    </div>
                                    <ul class="social">
                                        <button  onclick = "followedUser('{{g.id}}')" >
                                            <a href="#"  id={{"followuser_{0}".format(g.id)}} class="followerButton">Unfollow</a>
                                        </button>  
                                    </ul>
                                </div>
                            </div>
                            </a>
                            {% endfor %}
                        </div>
                </div>
        </div>
    </div>
    </div>

    </div>
    </div>

    </div>


    </div>
    </div>


    </div>

    </div>
    </div>

    </div>

    </div>

    <script type="text/javascript">
        $(document).ready(function() {
            $(".profile-contentCenter").show('slow');
            $(".FollowersContainer").hide();
            $(".FollowingContainer").hide();
            $(".FollowedQuestionsContainer").hide();
            $(".AnsweredQuestionsContainer").hide();
            $("#hider").hide();
            $("#popup_box1").hide();
        });
        $(".profile-contentCenter").click(function() {
            $("#hider").fadeIn("slow");
            $('#popup_box1').fadeIn("slow");

            $("#buttonClose").click(function() {
                $("#hider").fadeOut("slow");
                $('#popup_box1').fadeOut("slow");
            });
            $("#hider").click(function() {
                $("#hider").fadeOut("slow");
                $('#popup_box1').fadeOut("slow");
            });
        });
        $("#profile-PostButton").click(function() {
            $(".profile-contentCenter").show('slow');
            $(".FollowersContainer").hide();
            $(".FollowingContainer").hide();
            $(".FollowedQuestionsContainer").hide();
            $(".AnsweredQuestionsContainer").hide();
            $(".profile-contentRight").show('slow');
            $(".profile-contentLeft").show('slow');
            $(".profileCenterDiv").show('slow');
        });
        $("#profile-FollowersButton").click(function() {
            $(".profile-contentCenter").hide();
            $(".FollowersContainer").show('slow');
            $(".FollowingContainer").hide();
            $(".FollowedQuestionsContainer").hide();
            $(".AnsweredQuestionsContainer").hide();
            $(".profile-contentRight").hide();
            $(".profile-contentLeft").hide();
            $(".profileCenterDiv").hide();
        });
        $("#profile-FollowingButton").click(function() {
            $(".profile-contentCenter").hide();
            $(".FollowersContainer").hide();
            $(".FollowingContainer").show('slow');
            $(".FollowedQuestionsContainer").hide();
            $(".AnsweredQuestionsContainer").hide();
            $(".profile-contentRight").hide();
            $(".profile-contentLeft").hide();
            $(".profileCenterDiv").hide();
        });
        $("#profile-FollowedQuestionButton").click(function() {
            $(".profile-contentCenter").show();
            $(".FollowersContainer").hide();
            $(".FollowingContainer").hide();
            $(".FollowedQuestionsContainer").show('slow');
            $(".AnsweredQuestionsContainer").hide();
            $(".profile-contentRight").show('slow');
            $(".profile-contentLeft").show('slow');
            $(".profileCenterDiv").show('slow');
        });
        $("#profile-AnsweredQuestionButton").click(function() {
            $(".profile-contentCenter").show('slow');
            $(".FollowersContainer").hide();
            $(".FollowingContainer").hide();
            $(".FollowedQuestionsContainer").hide();
            $(".AnsweredQuestionsContainer").show('slow');
            $(".profile-contentRight").show('slow');
            $(".profile-contentLeft").show('slow');
            $(".profileCenterDiv").show('slow');
        });

        $('#followus').on('click', function() {
            $.ajax({
                type: 'HEAD',
                async: true,
                url: 'http://iitoverflow.herokuapp.com/api/users/{{ curuser }}/following/rel/{{ user }}',
                success: function(message) {
                    $.ajax({
                        type: 'DELETE',
                        async: true,
                        url: 'http://iitoverflow.herokuapp.com/api/users/{{ curuser }}/following/rel/{{ user }}',
                        success: function(message) {
                            $("#followusText").text("Follow");
                            console.log("unfollowed")
                        },
                        error: function(message) {
                            console.log(message);
                        }
                    });
                    $('#followusText').text("Follow")
                },
                error: function(message) {
                    if (message.status == 404) {
                        $.ajax({
                            type: "PUT",
                            async: true,
                            url: 'http://iitoverflow.herokuapp.com/api/users/{{ curuser }}/following/rel/{{ user }}',
                            success: function(message) {
                                $("#followusText").text("Unfollow");
                                console.log("Followed");

                            }
                        });
                    }
                }
            });
        });

      function upvote(qid) {
            console.log(qid);
            $.ajax({
                type: 'HEAD',
                async: true,
                url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/questionsupvoted/rel/'+qid,
                success: function(message) {
                    console.log("Already upvoted!");
                    
                },
                error: function(message) {
                    if (message.status == 404) {
                        $.ajax({
                            type: "PUT",
                            async: true,
                            url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/questionsupvoted/rel/'+qid,
                            success: function(message) {
                               $.ajax({
                                   type: "DELETE",
                                   async: true,
                                   url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/questionsdownvoted/rel/'+qid,
                                   success: function() {
                                       console.log("Sucessful deleted downvote after upvote!");
                                       console.log(".glyphicon glyphicon-thumbs-up#"+qid);
                                       $(".glyphicon glyphicon-thumbs-up#"+qid).css("color", "blue");
                                   }
                               });
                               console.log("Upvoted question!");

                            }
                        });
                    }
                }
            });
        }

        function downvote(qid) {
            console.log(qid);
            $.ajax({
                type: 'HEAD',
                async: true,
                url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/questionsdownvoted/rel/'+qid,
                success: function(message) {
                    console.log("Already downvoted!");
                },
                error: function(message) {
                    if (message.status == 404) {
                        $.ajax({
                            type: "PUT",
                            async: true,
                            url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/questionsdownvoted/rel/'+qid,
                            success: function(message) {
                                $.ajax({
                                   type: "DELETE",
                                   async: true,
                                   url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/questionsupvoted/rel/'+qid,
                                   success: function() {
                                       console.log("Sucessful deleted upvote after downvote!");
                                       console.log(".glyphicon glyphicon-thumbs-down#"+qid);
                                   }
                               });
                                console.log("Downvoted question!");

                            }
                        });
                    }
                }
            });
        }
    
        function followedQuestion(qid){
            $.ajax({
                type: "HEAD",
                async: true,
                url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/questionsfollowed/rel/'+qid,
                success: function(message){
                    $.ajax({
                        type: 'DELETE',
                        async: true,
                        url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/questionsfollowed/rel/'+qid,
                        success: function(message){
                            $('#followques_'+qid).text('Follow');
                            console.log('UNFOLLOWED');
                        },
                        error: function(message){
                            console.log(message);
                        }
                    });
                    $('#followques').text('Follow')
                },
                error: function(message){
                    console.log("FOLLOW QUESTION");
                        console.log("FOLLOW QUESTION");
                        $.ajax({
                            type: "PUT",
                            async: true,
                            url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/questionsfollowed/rel/'+qid,
                            success: function(message){
                                $('#followques_'+qid).text('Unfollow');
                                console.log('Followed');
                            }
                        });
                }

            });
        }

        function followedUser(uid){
            $.ajax({
                type: "HEAD",
                async: true,
                url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/following/rel/'+uid,
                success: function(message){
                    $.ajax({
                        type: 'DELETE',
                        async: true,
                        url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/following/rel/'+uid,
                        success: function(message){
                            $('#followuser_'+uid).text('Follow');
                            console.log('UNFOLLOWED');
                        },
                        error: function(message){
                            console.log(message);
                        }
                    });
                    $('#followuser_').text('Follow')
                },
                error: function(message){
                    console.log("FOLLOW QUESTION");
                        console.log("FOLLOW QUESTION");
                        $.ajax({
                            type: "PUT",
                            async: true,
                            url: 'http://iitoverflow.herokuapp.com/api/users/{{curuser}}/following/rel/'+uid,
                            success: function(message){
                                $('#followuser_'+uid).text('Unfollow');
                                console.log('Followed');
                            }
                        });
                }

            });
        }
            
    function followable(qid){
        
        $.ajax({
            type: "HEAD",
            async: true,
            url: 'http://iitoverflow.herokuapp.com/api/users/{{ curuser }}/following/rel/'+qid,
            success: function(message){
                $.ajax({
                    type: 'DELETE',
                    async: true,
                    url: 'http://iitoverflow.herokuapp.com/api/users/{{ curuser }}/following/rel/'+qid,
                    success: function(message){
                        $('#followa_'+qid).text('Follow');
                        console.log('UNFOLLOWED');
                    },
                    error: function(message){
                        console.log(message);
                    }
                });
                $('#followa_').text('Follow')
            },
            error: function(message){
                console.log("FOLLOW USER");
                    console.log("FOLLOW USERRRS");
                    $.ajax({
                        type: "PUT",
                        async: true,
                        url: 'http://iitoverflow.herokuapp.com/api/users/{{ curuser }}/following/rel/'+qid,
                        success: function(message){
                            $('#whotoFollow_'+qid).hide('slow');
                            $('#whotoFollow_'+qid).remove();
                            console.log('Followed');
                        }
                    });
            }
        });
    }

    

function signOut() {
    var auth2 = gapi.auth2.getAuthInstance();
    auth2.signOut().then(function() {
        $.ajax({
            url: "http://localhost:5000/logout",
            dataType: "json",
            success: function(resp) {
                if (resp.message = "okay") {
                    window.location.replace('/');
                } else {
                    console.log("Something went wrong")
                }
            },
            error: function(e) {
                console.log('ERROR')
            }
        });
    });
}


$(".showallButton").click(function(){
        var id = $(this).attr("id");
        if($(this).text()=== "Show description"){
            $(this).text("Hide description");
            $("#show_"+id).show('slow');
        }
        else{
            $(this).text("Show description");
            $("#show_"+id).hide('slow');
        }
       
    });


    </script>

    <script>
         var url = "https://iitoverflow.herokuapp.com/api/";
 // var url = "http://localhost:3000/api/";
 // var socketUrl = 'http://localhost:3000';
 var socketUrl = "https://iitoverflow.herokuapp.com";
 var user = {{ me_user | tojson}};
 console.log(user);
 var socketUser = "{{ me_user.id |safe}}";
 ///////////////////////////////////////////////////////////////////////////////////
 //var socketUser =2;
 var questionFollowing = {{me_following_questions |tojson}};
 var userFollowing = {{me_followed | tojson}};
 var interests = {{me_interests | tojson}};
///////////////////////////////////////////////////////////////////////////////////
$(document).ready(function() {

     
 
 var oldnotifs = {{me_notifications|tojson}};
 oldnotifs.forEach(element => {
 if(element.type == 'newQuestion'){
     
     var holdNewQuestionHtml =
         '<li><a href="/Question/' + element.question.id +
         '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
             element.user.picture +
         '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;"><strong class="text-info">' +
                 element.user.displayname + '</strong> posted a new Question: ' + element.question.question +
         '<div><small class="text-warning">' + getDate(element.question.createdAt) +
         '</small> </div></div> </div></a></li>';
     $("#notification-content").append(holdNewQuestionHtml);

 }else if(element.type == 'newAnswer'){

     var holdNewAnswerHtml = "";
     if (element.question.userId == socketUser) {
         holdNewAnswerHtml +=
             '<li><a href="/Question/' + element.question.id +
             '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
                 element.user.picture +
             '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8"><strong class="text-info">' +
                 element.user.displayname + '</strong> answered your question: ' + element.answer.answer +
             '<div><small class="text-warning">' + getDate(element.answer.createdAt) +
             '</small> </div></div> </div></a></li>';

         $("#notification-content").append(holdNewAnswerHtml);
     } else if ($.grep(questionFollowing, function(obj) {
             return obj.id === element.question.id;
         })[0]) {
         holdNewAnswerHtml +=
             '<li><a href="/Question/' + element.question.id +
             '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
                 element.user.picture +
             '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8"><strong class="text-info">' +
                 element.user.displayname + '</strong> answered a question you\'re following: ' + element.answer.answer +
             '<div><small class="text-warning">' + getDate(element.answer.createdAt) +
             '</small> </div></div> </div></a></li>';

         $("#notification-content").append(holdNewAnswerHtml);
     }

 }else if(element.type == 'newComment'){
     holdNewAnswerHtml +=
             '<li><a href="/Question/' + element.question.id +
             '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
                 element.user.picture +
             '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8"><strong class="text-info">' +
                 element.user.displayname + '</strong> commented on your answer: ' + element.comment.comment +
             '<div><small class="text-warning">' + getDate(element.comment.createdAt) +
             '</small> </div></div> </div></a></li>';

         $("#notification-content").append(holdNewAnswerHtml);


 }
 
 });
 reloadchatlist();
});
</script>

<script>
///////////////////////////////////////////////////////////////////////////////////
const chatSocket = io(socketUrl + '/chat');
 const notificationSocket = io(socketUrl + '/notification');


 chatSocket.on('connection', function(socket) {


     //console.log("connected");

 });
 chatSocket.on('wentOffline', function(data) {
     $("#user_" + data.user + "_status").attr("class", "");

     //console.log(data.user, " is now offline");
 });
 chatSocket.on('wentOnline', function(data) {
     $("#user_" + data.user + "_status").attr("class", "contact-status online");

     //console.log(data.user, " is now online");
 });
 notificationSocket.on('newQuestion', function(data) {
     //console.log("New Question");
     //console.log(data);
     console.log("NewQuestion",data);
     var holdNewQuestionHtml = "";
     if (data.question.userId != socketUser)
         if ($.grep(userFollowing, function(obj) {
                 return obj.id === data.question.userId;
             })[0] || $.grep(interests, function(obj) {
                 return obj.id === data.question.categoryId;
             })[0]) {
             holdNewQuestionHtml +=
                 '<li><a href="/Question/' + data.question.id +
                 '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
                 data.user.picture +
                 '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8"><strong class="text-info">' +
                 data.user.displayname + '</strong> posted a new Question: ' + data.question.question +
                 '<div><small class="text-warning">' + "Just now" +
                 '</small> </div></div> </div></a></li>';
             $("#notification-content").prepend(holdNewQuestionHtml);

         }
 });
 notificationSocket.on('newAnswer', function(data) {
     console.log("NewAnswer",data);
     var holdNewAnswerHtml = "";
     if (data.answer.userId != socketUser)
     if (data.question.userId == socketUser) {
         holdNewAnswerHtml +=
             '<li><a href="/Question/' + data.question.id +
             '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
             data.user.picture +
             '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8"><strong class="text-info">' +
             data.user.displayname + '</strong> answered your question: ' + data.answer.answer +
             '<div><small class="text-warning">' +"Just now"+
             '</small> </div></div> </div></a></li>';

         $("#notification-content").prepend(holdNewAnswerHtml);
     } else if ($.grep(questionFollowing, function(obj) {
             return obj.id === data.question.id;
         })[0]) {
         holdNewAnswerHtml +=
             '<li><a href="/Question/' + data.question.id +
             '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
             data.user.picture +
             '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8"><strong class="text-info">' +
             data.user.displayname + '</strong> answered a question you\'re following: ' + data.answer.answer +
             '<div><small class="text-warning">' + "Just now" +
             '</small> </div></div> </div></a></li>';

         $("#notification-content").prepend(holdNewAnswerHtml);
     }

     //console.log("New Answer");
     //console.log(data);
 });
 notificationSocket.on('newComment', function(data) {
     console.log("NewComment",data);
     var holdNewAnswerHtml = "";
     if (data.answer.userId == socketUser && data.comment.userId != socketUser) {
         holdNewAnswerHtml +=
             '<li><a href="/Question/' + data.question.id +
             '" class="notification-box"><div class="row"><div class="col-lg-3 col-sm-3 col-3 text-center"><img src="' +
             data.user.picture +
             '" class="w-50 img-circle" width="30" height="30" ></div><div class="col-lg-8 col-sm-8 col-8"><strong class="text-info">' +
             data.user.displayname + '</strong> commented on your answer: ' + data.comment.comment +
             '<div><small class="text-warning">' + "Just now" +
             '</small> </div></div> </div></a></li>';

         $("#notification-content").prepend(holdNewAnswerHtml);
     }
     //console.log("New Comment");
     //console.log(data);
 });
 chatSocket.on('message', function(data) {
     
     console.log("newMessage",data);

     m_pic = data.user.picture;
     if(!($("#unread_solo_" + data.message.conversationId).length)){
         openConversation(data.message.senderId);

     }else if (popups.indexOf("solo_" + data.message.conversationId) > -1) {


         var m_element =
             '<div class="row msg_container base_receive"><div class="col-md-2 col-xs-2 avatar"><img src="' +
             m_pic +
             '" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive"><p>' +
             data.message.message +
             '</p><time style ="text-align:left;" datetime="2009-11-13T20:00">' +
             data.user.displayname +
             '</time></div></div></div>';

         $("#m_solo_" + data.message.conversationId).append(m_element);



         var panel = $("#m_solo_" + data.message.conversationId);
         //$('#m_'+id).animate({scrollTop: $('#m_'+id).get(0).scrollHeight}, 700);
         $("#m_solo_" + data.message.conversationId).scrollTop($(
                 "#m_solo_" + data.message.conversationId).get(0)
             .scrollHeight);
     } else if ($("#unread_solo_" + data.message.conversationId).length) {
         if ($("#unread_solo_" + data.message.conversationId).html() == '') {
             $("#unread_solo_" + data.message.conversationId).html("1");
         } else {
             var holdValue = parseInt($("#unread_solo_" + data.message.conversationId).html());
             //console.log(holdValue++);
             $("#unread_solo_" + data.message.conversationId).html(holdValue);
         }
     }
 });
 chatSocket.emit("connected", {
     id: socketUser
 });
 sendMessage2 = function() {
     ////console.log($("#message").val());
     chatSocket.emit("messageSent", $("#message").val());

 }

 getDate = function(date) {

     var date2 = new Date().getTime() - new Date(date).getTime();

     var seconds = Math.floor(date2 / 1000);

     if (Math.floor(seconds / 3600) >= 24)
         return new Date(date).toUTCString();

     if (Math.floor(seconds / 3600))
         return "" + Math.floor(seconds / 3600) + " hours ago";

     if (Math.floor(seconds / 60))
         return "" + Math.floor(seconds / 60) + " minutes ago";

     if (Math.floor(seconds / 1))
         return "" + Math.floor(seconds / 1) + " seconds ago";

     return "Just now";
     return new Date(date).toUTCString();



 }

///////////////////////////////////////////////////////////////////////////////////
</script>

<script type="text/javascript">
 ///////////////////////////////////////////////////////////////////////////////////
 //var url = "http://localhost:3000/api/";
 function isOnline(online, id) {
     console.log("online: ", online);
     return (online ? '<span id="user_' + id + '_status" class="contact-status online"></span>' : '<span id="user_' + id + '_status"></span>');
 }
 ///////////////////////////////////////////////////////////////////////////////////
 function openConversation(id){
     $.ajax({
         url: url + "users/" + socketUser + "/getconversation/"+id,
         method: 'get',
         dataType: "JSON",
         headers: {
             'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
         },
         success: function(data) {
             //console.log(data);
             var convolist = data;
             var convoStore = "";
             var profilepic;
             if($("#unread_"+convolist.id).length){
                 register_popup(convolist.id,convolist.displayname);
             }else{
                 profilepic = convolist.profilepic;
                 convoStore += '<div class="sidebar-name " onclick="javascript:register_popup( \'' +
                     convolist.id + '\',\'' + convolist.displayname +
                     '\');"> <div class="convoName"><a class="wrap"style="position: relative;">' + isOnline(convolist.online, convolist.userid) + '<img class="img-circle" width="30" height="30" src="' +
                     profilepic + '" /><span>' + convolist.displayname + '</span>';

                 // if (convolist[i].unread > 0) {
                 convoStore += '<span id="unread_' + convolist.id +
                     '" style="position: absolute;bottom: -2px;left: -2px;"  class="label label-danger">' +
                     (convolist.unread == 0 ? '' : convolist.unread) + '</span>';
                 //}


                 convoStore += '</a></div></div>';
             

                 $("#convos").prepend(convoStore);
                 register_popup(convolist.id,convolist.displayname);
             }


                 
             
         },
         error: function(data) {}
     });

 }
 ///////////////////////////////////////////////////////////////////////////////////
 function reloadchatlist() {
     $.ajax({
         url: url + "users/" + socketUser + "/chatlist",
         method: 'get',
         dataType: "JSON",
         headers: {
             'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
         },
         success: function (data) {
             console.log(data);
             var convolist = data;
             var convoStore = "";
             var profilepic;
             for (var i = 0; i < convolist.length; i++) {
                 profilepic = convolist[i].profilepic;
                 convoStore += '<div class="sidebar-name " onclick="javascript:register_popup( \'' +
                     convolist[i].id + '\',\'' + convolist[i].displayname +
                     '\');"> <div class="convoName"><a class="wrap"style="position: relative;">' + isOnline(convolist[i].online, convolist[i].userid) + '<img class="img-circle" width="30" height="30" src="' +
                     profilepic + '" /><span>' + convolist[i].displayname + '</span>';
                 // if (convolist[i].unread > 0) {
                 convoStore += '<span id="unread_' + convolist[i].id +
                     '" style="position: absolute;bottom: -2px;left: -2px;"  class="label label-danger">' +
                     (convolist[i].unread == 0 ? '' : convolist[i].unread) + '</span>';
                 //}
                 convoStore += '</a></div></div>';
                 
             }
             $("#convos").html(convoStore);
             return true;
         },
         error: function (data) { 
             return false;
         }

     });
     
 }
///////////////////////////////////////////////////////////////////////////////////

</script>

<script type="text/javascript" charset="utf-8" async defer>
 ///////////////////////////////////////////////////////////////////////////////////
 $(document).ready(function () {
     var chatHtml = '<div class="container sideChatContainer">' +
         '<div id="sideChat">' +
         '<div id="sideChatHeader" type="button" class="btn btn-primary chatBtn" data-toggle="collapse" data-target="#chatBody" style="display: inline-flex;">' +
         '<div style="width: 200px;">' +
         '<label  id="chatLabel" style="float:left;padding-left:10px;padding-top: 2px;">Chat </label>' +
         '</div>' +
         '<div >' +
         '<!--<a  id = "optionBtn" role="button" class="glyphicon glyphicon-cog button" data-target="Options" data-toggle="collapse2" data-hover="tooltip" data-tooltip-content="Options" data-tooltip-position="below" style="font-size: 15px;text-decoration: none;"></a>-->' +
         '</div>' +
         '</div>' +
         '<div id="chatBody" class="collapse">' +
         '<div id="convos" class="chat-sidebar tabcontent convos" style="padding-top: 2px;overflow-y: scroll;">' +
         '</div> </div></div></div>';
     $("#sideChat").replaceWith(chatHtml);
     $('.chatBody').collapse();
     reloadchatlist();
 });
///////////////////////////////////////////////////////////////////////////////////
$(document).on('click','#sideChatHeader', function(e){
 reloadchatlist();
});
</script>

<script type="text/javascript">
 ///////////////////////////////////////////////////////////////////////////////////
 $('#optionBtn').click(function (e) {
     e.stopPropagation();
 });
 ///////////////////////////////////////////////////////////////////////////////////
 function openTab(evt, tabName) {
     // Declare all variables
     var i, tabcontent, tablinks;
     // Get all elements with class="tabcontent" and hide them
     tabcontent = document.getElementsByClassName("chat-sidebar");
     for (i = 0; i < tabcontent.length; i++) {
         tabcontent[i].style.display = "none";
     }
     // Get all elements with class="tablinks" and remove the class "active"
     tablinks = document.getElementsByClassName("tablinks");
     for (i = 0; i < tablinks.length; i++) {
         tablinks[i].className = tablinks[i].className.replace(" active", "");
     }
     // Show the current tab, and add an "active" class to the button that opened the tab
     document.getElementById(tabName).style.display = "block";
     evt.currentTarget.className += " active";
 }
 ///////////////////////////////////////////////////////////////////////////////////
 $(document).ready(function () {
     $('.chatBody').collapse();
 });
///////////////////////////////////////////////////////////////////////////////////
</script>

<script type="text/javascript">
 ///////////////////////////////////////////////////////////////////////////////////
 var m_pic;
 var m_id;
 var m_element
 $(document).ready(function () {
     if (popups.length > 0) {
         $.ajax({
             url: "/updateChat",
             method: "GET",
             data: {
                 id: popups
             },
             dataType: "JSON",
             headers: {
                 'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
             },
             success: function (data) {
                 //console.log(data);
                 if (data.length != 0) {
                     //console.log(popups);
                     //console.log(data[0].id)
                     for (var i = 0; i < data.length; i++) {
                         if (data[i].profilePic != null) {
                             m_pic = "/avatar/" + data[i].profilePic;
                         } else {
                             m_pic =
                                 "http://www.bitrebels.com/wp-content/uploads/2011/02/Original-Facebook-Geek-Profile-Avatar-1.jpg";
                         }
                         if (popups.indexOf("solo_" + data[i].conversationId) > -1) {
                             m_element =
                                 '<div class="row msg_container base_receive"><div class="col-md-2 col-xs-2 avatar"><img src="' +
                                 m_pic +
                                 '" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive"><p>' +
                                 data[i].message +
                                 '</p><time style ="text-align:left;" datetime="2009-11-13T20:00">' +
                                 data[i].firstname + ' ' + data[i].lastname +
                                 '</time></div></div></div>';
                             $("#m_solo_" + data[i].conversationId).append(m_element);
                             var panel = $("#m_solo_" + data[i].conversationId);
                             //$('#m_'+id).animate({scrollTop: $('#m_'+id).get(0).scrollHeight}, 700);
                             $("#m_solo_" + data[i].conversationId).scrollTop($(
                                 "#m_solo_" + data[i].conversationId).get(0)
                                 .scrollHeight);
                         }
                     }
                 }
             },
             error: function (data) {
             }
         });
     }
     //code goes here that will be run every 5 seconds.
 });
///////////////////////////////////////////////////////////////////////////////////
</script>
<script type="text/javascript">
 ///////////////////////////////////////////////////////////////////////////////////
 function urlify(text) {
     var urlRegex = /(((https?:\/\/)|(www\.))[^\s]+)/g;
     //var urlRegex = /(https?:\/\/[^\s]+)/g;
     return text.replace(urlRegex, function (url, b, c) {
         var url2 = (c == 'www.') ? 'http://' + url : url;
         return '<a href="' + url2 + '" target="_blank">' + url + '</a>';
     })
 }
 ///////////////////////////////////////////////////////////////////////////////////
 function sendMessage($id, $message, $this, $message_panel) {
     if ($message != '') {
         $this.parents('.popup-box').find('.chat_input').val('');
         $.ajax({
             url: url + "users/" + socketUser + "/conversation/" + $id.split("_")[1],
             method: "POST",
             data: {
                 msg: $message
             },
             dataType: "JSON",
             headers: {
                 'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
             },
             success: function (data) {
                 var $element = '';
                 var profilepic;
                 profilepic = user.picture;
                 $element += '<div id="' + data.id +
                     '"  class="row msg_container base_sent"><div class="col-md-10 col-xs-10"><div class="messages msg_sent"><p>';
                 $element += $message;
                 $element +=
                     '</p><time class ="time"datetime="2009-11-13T20:00">You</time></div></div><div class="col-md-2 col-xs-2 avatar"><img src="' +
                     profilepic + '" class=" img-responsive "></div></div>';
                 $hold = $($element);
                 $message_panel.append($hold);
                 //$message_panel.animate({ scrollTop: $(element).offset().top }, 1000);
                 $message_panel.animate({
                     scrollTop: $message_panel.get(0).scrollHeight
                 }, 700);
             },
             error: function (data) {
             }
         });
     }
 }
 ///////////////////////////////////////////////////////////////////////////////////
 $(document).on('keyup', '.chat_input', function (e) {
     if (e.which === 13) {
         //return sendMessage(getMessageText());
         var $this = $(this);
         var $message = urlify($this.parents('.popup-box').find('.chat_input').val().trim());
         var $message_panel = $this.parents('.popup-box').find('.popup-messages');
         var $id = $this.parents('.popup-box').attr('id');
         sendMessage($id, $message, $this, $message_panel)
     }
 });
 ///////////////////////////////////////////////////////////////////////////////////
 $(document).on('click', '.popup-box button.btn-chat', function (e) {
     var $this = $(this);
     var $message = urlify($this.parents('.popup-box').find('.chat_input').val().trim());
     var $message_panel = $this.parents('.popup-box').find('.popup-messages');
     var $id = $this.parents('.popup-box').attr('id');
     sendMessage($id, $message, $this, $message_panel);
 });
 ///////////////////////////////////////////////////////////////////////////////////
 $(document).on('click', '.panel-heading span.icon_minim', function (e) {
     var $this = $(this);
     if (!$this.hasClass('panel-collapsed')) {
         $this.parents('.popup-box').find('.message_body').slideUp();
         $this.addClass('panel-collapsed');
         $this.removeClass('glyphicon-minus').addClass('glyphicon-plus');
     } else {
         $this.parents('.popup-box').find('.message_body').slideDown();
         $this.removeClass('panel-collapsed');
         $this.removeClass('glyphicon-plus').addClass('glyphicon-minus');
     }
 });
 ///////////////////////////////////////////////////////////////////////////////////
 //this function can remove a array element.
 Array.remove = function (array, from, to) {
     var rest = array.slice((to || from) + 1 || array.length);
     array.length = from < 0 ? array.length + from : from;
     return array.push.apply(array, rest);
 };
 ///////////////////////////////////////////////////////////////////////////////////
 //this variable represents the total number of popups can be displayed according to the viewport width
 var total_popups = 0;
 //arrays of popups ids
 var popups = [];
 //this is used to close a popup
 function close_popup(id) {
     for (var iii = 0; iii < popups.length; iii++) {
         if (id == popups[iii]) {
             Array.remove(popups, iii);
             document.getElementById('b_' + id).style.display = "block";
             document.getElementById(id).style.display = "none";
             //$("#"+id).remove();
             $("#" + id + " span.icon_minim").removeClass('glyphicon-plus').addClass('glyphicon-minus');
             calculate_popups();
             return;
         }
     }
 }
 ///////////////////////////////////////////////////////////////////////////////////
 //displays the popups. Displays based on the maximum number of popups that can be displayed on the current viewport width
 function display_popups() {
     var right = 330;
     var iii = 0;
     for (iii; iii < total_popups; iii++) {
         if (popups[iii] != undefined) {
             var element = document.getElementById(popups[iii]);
             element.style.right = right + "px";
             right = right + 280;
             element.style.display = "block";
         }
     }
     for (var jjj = iii; jjj < popups.length; jjj++) {
         var element = document.getElementById(popups[jjj]);
         element.style.display = "none";
     }
 }
 ///////////////////////////////////////////////////////////////////////////////////
 //creates markup for a new popup. Adds the id to popups array.
 function register_popup(id, name) {
     for (var iii = 0; iii < popups.length; iii++) {
         //already registered. Bring it to front.
         if (id == popups[iii]) {
             Array.remove(popups, iii);
             popups.unshift(id);
             calculate_popups();
             return;
         }
     }
     var element = '<div class="popup-box chat-popup" id="' + id + '" > ';
     element = element + '<div class="panel-heading popup-head" >';
     element = element + '<div class="popup-head-left">' + name + '</div>';
     element = element +
         '<div class="popup-head-right"><a ><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a><a href="javascript:close_popup(\'' +
         id + '\');">&#10005;</a></div>';
     element = element + '<div style="clear: both"></div></div><div id="b_' + id + '" class="message_body ' + id +
         '" ><div id="m_' + id + '" class="popup-messages">';
     element +=
         '</div><div class="input-group" style="padding-top:4px;padding-bottom:4px;"><input id="btn-input" class="form-control input-sm chat_input" placeholder="Write your message here..." type="text" style="float:bottom"><span class="input-group-btn"><button class="btn-chat btn btn-primary btn-sm">Send</button> </span></div></div></div>';
     // Insert msg body
     document.getElementsByTagName("body")[0].innerHTML = document.getElementsByTagName("body")[0].innerHTML +
         element;
     popups.unshift(id);
     calculate_popups();
     $.ajax({
         url: url + "/users/" + socketUser + "/conversation/" + id.split("_")[1],
         method: "GET",
         headers: {
             'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
         },
         success: function (data) {
             var element = '';
             data = data;
             var pic;
             for (var i = 0; i < data.length; i++) {
                 var $messageData = data[i];
                 pic = $messageData.picture;
                 console.log("message", $messageData);
                 console.log("sender: ", $messageData.senderid, " user: ", socketUser);
                 if ($messageData.senderid == socketUser) {
                     element +=
                         '<div class="row msg_container base_sent"><div class="col-md-10 col-xs-10"><div class="messages msg_sent"><p>' +
                         $messageData.message +
                         '</p><time datetime="2009-11-13T20:00">You</time></div></div><div class="col-md-2 col-xs-2 avatar"><img class="chatvatar" src="' +
                         pic + '" class=" img-responsive "></div></div>';
                 } else {
                     element +=
                         '<div class="row msg_container base_receive"><div class="col-md-2 col-xs-2 avatar"><img src="' +
                         pic +
                         '" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive"><p>' +
                         $messageData.message +
                         '</p><time style ="text-align:left;" datetime="2009-11-13T20:00">' + $messageData.displayname + '</time></div></div></div>';
                 }
             }
             $("#m_" + id).empty();
             $("#m_" + id).append(element);
             var panel = $('#m_' + id);
             //$('#m_'+id).animate({scrollTop: $('#m_'+id).get(0).scrollHeight}, 700);
             $('#m_' + id).scrollTop($('#m_' + id).get(0).scrollHeight);
         },
         error: function (data) {
         }
     });
     document.getElementById(id).style.display = "block";
     $("#unread_" + id).html('');
 }
 ///////////////////////////////////////////////////////////////////////////////////
 //calculate the total number of popups suitable and then populate the toatal_popups variable.
 function calculate_popups() {
     var width = window.innerWidth;
     if (width < 540) {
         total_popups = 0;
     } else {
         width = width - 200;
         //320 is width of a single popup box
         total_popups = parseInt(width / 320);
     }
     display_popups();
 }
 ///////////////////////////////////////////////////////////////////////////////////
 //recalculate when window is loaded and also when window is resized.
 window.addEventListener("resize", calculate_popups);
 window.addEventListener("load", calculate_popups);
 ///////////////////////////////////////////////////////////////////////////////////
</script>


</body>